<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Enfermeiro Inteligente - Sincronizado</title>
    <!-- REMOVIDO: Scripts do Firebase antigo -->
    <!-- ADICIONADO: Scripts do Firebase compat v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- ADICIONADO: Importa√ß√£o do arquivo de configura√ß√£o externo -->
    <script src="../firebase-config.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        .btn-principal, .btn-secundario, .btn-icon {
            transition: all 0.2s ease-in-out;
        }
        .btn-principal:active, .btn-secundario:active, .btn-icon:active {
            transform: scale(0.95);
        }
        /* Estilos restantes do seu CSS original */
        /* ... (restante do CSS do seu arquivo original)... */
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <div id="auth-container" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Acesso Negado</h1>
            <p class="text-gray-600">Sua sess√£o √© inv√°lida ou expirou. Por favor, retorne √† plataforma e fa√ßa login novamente.</p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6" style="display: none;">
        <header class="text-center mb-8 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <a href="../dashboard.html" class="p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition no-print" title="Voltar ao Dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </a>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600">
                        Controle de Tratamento
                    </h1>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="user-email" class="text-sm text-gray-600 hidden sm:inline-block"></span>
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">Sair</button>
                </div>
            </div>
            <div class="flex flex-wrap justify-center gap-2 mb-4 print:hidden">
                <button id="btn-tab-pacientes" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium tab-btn active" data-tab="pacientes">üë§ Pacientes</button>
                <button id="btn-tab-tratamentos" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium tab-btn" data-tab="tratamentos">üíä Tratamentos</button>
                <button id="btn-tab-checklist" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium tab-btn" data-tab="checklist">‚úÖ Checklist</button>
                <button id="btn-tab-relatorios" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium tab-btn" data-tab="relatorios">üìä Relat√≥rios</button>
                <button id="btn-tab-config" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium tab-btn" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
            </div>
        </header>

        <main>
            <!-- Aba Pacientes -->
            <div id="tab-pacientes" class="tab-content active">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Adicionar Novo Paciente</h2>
                    <div class="mb-4">
                        <label for="nome-paciente" class="block text-gray-700 font-bold mb-2">Nome do Paciente</label>
                        <input type="text" id="nome-paciente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nome completo">
                    </div>
                    <button id="salvar-paciente-btn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-lg shadow-md hover:from-purple-700 hover:to-indigo-700 transition transform hover:-translate-y-0.5">‚ûï Criar Perfil</button>
                </div>
                <div id="pacientes-lista" class="space-y-6"></div>
            </div>

            <!-- Aba Tratamentos -->
            <div id="tab-tratamentos" class="tab-content">
                 <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Adicionar Novo Tratamento</h2>
                    <input type="hidden" id="tratamento-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="nome-remedio" class="block text-gray-700 font-bold mb-2">Nome do Rem√©dio</label>
                            <input type="text" id="nome-remedio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Paracetamol">
                            <p id="error-nome-remedio" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="dosagem-remedio" class="block text-gray-700 font-bold mb-2">Dosagem</label>
                            <input type="text" id="dosagem-remedio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: 500mg">
                            <p id="error-dosagem-remedio" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="tipo-tratamento" class="block text-gray-700 font-bold mb-2">Tipo de Tratamento</label>
                        <select id="tipo-tratamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="temporario">Tempor√°rio</option>
                            <option value="continuo">Cont√≠nuo</option>
                        </select>
                    </div>
                    <div id="duracao-container" class="mb-4" style="display: none;">
                        <label for="duracao-tratamento" class="block text-gray-700 font-bold mb-2">Dura√ß√£o (dias)</label>
                        <input type="number" id="duracao-tratamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: 7">
                        <p id="error-duracao-tratamento" class="text-red-500 text-xs italic mt-1 hidden"></p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2">Hor√°rios de Tomada</label>
                        <div id="horarios-container" class="space-y-2 mb-2"></div>
                        <button type="button" id="adicionar-horario-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Adicionar Hor√°rio
                        </button>
                        <p id="error-horarios" class="text-red-500 text-xs italic mt-1 hidden"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="instrucoes-remedio" class="block text-gray-700 font-bold mb-2">Instru√ß√µes</label>
                            <select id="instrucoes-remedio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="antes">Antes das refei√ß√µes</option>
                                <option value="depois">Depois das refei√ß√µes</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div id="instrucoes-personalizadas-container" style="display: none;">
                            <label for="instrucoes-personalizadas" class="block text-gray-700 font-bold mb-2">Instru√ß√µes Personalizadas</label>
                            <input type="text" id="instrucoes-personalizadas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Tomar com √°gua">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button type="button" id="salvar-tratamento-btn" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-lg shadow-md hover:from-green-600 hover:to-teal-600 transition transform hover:-translate-y-0.5">üíæ Salvar Tratamento</button>
                        <button type="button" id="cancelar-tratamento-btn" class="flex-1 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition">‚Ü©Ô∏è Cancelar</button>
                    </div>
                </div>
                <div id="tratamentos-lista" class="space-y-6"></div>
            </div>

            <!-- Aba Checklist -->
            <div id="tab-checklist" class="tab-content">
                <div id="placeholder" class="bg-white rounded-2xl shadow-lg p-8 text-center mb-6" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhum Paciente Selecionado</h3>
                    <p class="text-gray-600">Selecione um paciente na aba 'Pacientes' para visualizar e gerenciar seus tratamentos.</p>
                </div>
                <div id="checklist-container" class="space-y-6"></div>
                <div id="main-controls" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-xl p-2 flex items-center space-x-2 print:hidden" style="display: none;">
                    <button id="btn-finalizar-dia" class="p-3 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-full shadow-md hover:from-green-600 hover:to-teal-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <button id="btn-gerar-relatorio" class="p-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-full shadow-md hover:from-blue-600 hover:to-indigo-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </button>
                </div>
                <div id="footer-progress" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm p-4 border-t border-gray-200 shadow-inner print:hidden" style="display: none;">
                    <div class="max-w-4xl mx-auto flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">Progresso do Dia (<span id="current-date"></span>)</span>
                        <div class="flex items-center">
                            <span id="progress-text" class="text-sm font-medium text-gray-700 mr-2">0%</span>
                            <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full bg-gradient-to-r from-green-400 to-teal-500 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Relat√≥rios -->
            <div id="tab-relatorios" class="tab-content">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Exportar Dados</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="exportar-csv-btn" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-bold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-600 transition transform hover:-translate-y-0.5 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="relatorios-lista" class="space-y-6"></div>
            </div>

            <!-- Aba Configura√ß√µes -->
            <div id="tab-config" class="tab-content">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Configura√ß√µes do App</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium text-gray-800">Modo Escuro</span>
                                <p class="text-sm text-gray-600">Ativar tema escuro para o aplicativo.</p>
                            </div>
                            <button id="toggle-dark-mode" class="relative inline-flex items-center h-6 rounded-full w-11 bg-gray-300 transition-colors focus:outline-none">
                                <span class="sr-only">Toggle Dark Mode</span>
                                <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium text-gray-800">Notifica√ß√µes</span>
                                <p id="notification-status" class="text-sm text-gray-600 mt-1">Status: Desconhecido. Clique para configurar.</p>
                            </div>
                            <button id="toggle-notifications" class="relative inline-flex items-center h-6 rounded-full w-11 bg-gray-300 transition-colors focus:outline-none" data-enabled="false">
                                <span class="sr-only">Toggle Notifications</span>
                                <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                            </button>
                        </div>
                        <div id="notification-settings" class="hidden p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="mb-4">
                                <label for="select-antecedencia" class="block text-gray-700 font-bold mb-2">Anteced√™ncia da Notifica√ß√£o (minutos)</label>
                                <select id="select-antecedencia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="5">5 minutos</option>
                                    <option value="10" selected>10 minutos</option>
                                    <option value="15">15 minutos</option>
                                    <option value="30">30 minutos</option>
                                </select>
                            </div>
                            <button id="btn-testar-notificacao" class="w-full py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">üß™ Testar Notifica√ß√£o</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-12 text-center text-gray-600 text-sm print:hidden">
            <p>Desenvolvido com ‚ù§Ô∏è por thIAguinho Solu√ß√µes</p>
            <p class="mt-1">Contato: (17) 99763-1210</p>
        </footer>
    </div>

    <!-- Overlay para Modais -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modal-title"></h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modal-body" class="mb-4"></div>
            <div class="flex justify-end space-x-2" id="modal-actions"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // REMOVIDO: Objeto firebaseConfig antigo
        // REMOVIDO: Chamada firebase.initializeApp(firebaseConfig);

        // INICIALIZA O FIREBASE COM A CONFIGURA√á√ÉO EXTERNA
        // As vari√°veis auth e database s√£o exportadas pelo firebase-config.js
        // const auth = firebase.auth(); // J√° dispon√≠vel via firebase-config.js
        // const database = firebase.database(); // J√° dispon√≠vel via firebase-config.js

        // ========================================
        // M√ìDULO DE GERENCIAMENTO DE DADOS (FIREBASE)
        // ========================================
        const DataManager = {
            uid: null,
            activePatientId: null,
            async init(uid) {
                this.uid = uid;
                // Ao iniciar, tenta carregar o paciente ativo salvo
                this.activePatientId = await this.getActivePatientId();
            },
            _getBaseRef() {
                if (!this.uid) return null;
                // Caminho base ajustado para a estrutura do Firebase
                return database.ref(`easy_lists/${this.uid}/enfermeiro_inteligente`);
            },
            async getActivePatientId() {
                 const ref = this._getBaseRef()?.child('active_patient_id');
                 if (!ref) return null;
                 const snapshot = await ref.once('value');
                 return snapshot.val();
            },
            async setActivePatientId(id) {
                 const ref = this._getBaseRef()?.child('active_patient_id');
                 if (!ref) return;
                 await ref.set(id);
                 this.activePatientId = id; // Atualiza a vari√°vel local
            },
            async getUsers() {
                // Busca os pacientes dentro do n√≥ espec√≠fico do usu√°rio
                const ref = this._getBaseRef()?.child('patients');
                if (!ref) return [];
                const snapshot = await ref.once('value');
                const data = snapshot.val();
                if (!data) return [];

                // Converte o objeto de pacientes em um array
                const users = [];
                for (const id in data) {
                    users.push({ id, ...data[id] });
                }
                return users;
            },
            _getPatientDataRef() {
                 if (!this.uid || !this.activePatientId) return null;
                 // Caminho para os dados espec√≠ficos do paciente ativo
                 return database.ref(`easy_lists/${this.uid}/enfermeiro_inteligente/${this.activePatientId}`);
            },
            async _getData(path) {
                const ref = this._getPatientDataRef()?.child(path);
                if (!ref) return null; // Retorna null se n√£o tiver paciente ativo
                const snapshot = await ref.once('value');
                return snapshot.val();
            },
            async _saveData(path, data) {
                const ref = this._getPatientDataRef()?.child(path);
                if (!ref) {
                    console.error('N√£o √© poss√≠vel salvar dados sem um paciente ativo.');
                    return false; // Falha ao salvar se n√£o houver paciente
                }
                await ref.set(data);
                return true; // Sucesso ao salvar
            },
            async carregarTratamentos() {
                // Carrega os tratamentos do paciente ativo
                return await this._getData('tratamentos') || [];
            },
            async salvarTratamentos(tratamentos) {
                // Salva os tratamentos do paciente ativo
                return await this._saveData('tratamentos', tratamentos);
            },
            async carregarDoses() {
                 return await this._getData('dosesDiarias') || [];
            },
            async salvarDoses(doses) {
                 return await this._saveData('dosesDiarias', doses);
            },
            async precisaGerarDosesHoje() {
                const hoje = new Date().toLocaleDateString('pt-BR');
                const ultimaGeracao = await this._getData('ultimaGeracao');
                return ultimaGeracao !== hoje;
            },
            async marcarGeracaoHoje() {
                const hoje = new Date().toLocaleDateString('pt-BR');
                await this._saveData('ultimaGeracao', hoje);
            },
            async carregarDarkMode() {
                const ref = this._getBaseRef()?.child('global_settings/darkMode');
                if (!ref) return false;
                const snapshot = await ref.once('value');
                return snapshot.val() === true;
            },
            async salvarDarkMode(ativado) {
                const ref = this._getBaseRef()?.child('global_settings/darkMode');
                if (!ref) return;
                await ref.set(ativado);
            },
             async carregarNotificacoes() {
                // Caminho ajustado para configura√ß√µes do paciente ativo
                return await this._getData('config/notificacoesAtivadas') || false;
            },
            async salvarNotificacoes(ativadas) {
                 // Caminho ajustado para configura√ß√µes do paciente ativo
                 const ref = this._getBaseRef()?.child('config/notificacoesAtivadas');
                 if (!ref) return;
                 await ref.set(ativadas);
            },
            async carregarAntecedencia() {
                 const val = await this._getData('config/antecedenciaNotificacao');
                 return typeof val === 'number' ? val : 10; // Valor padr√£o 10 minutos
            },
            async salvarAntecedencia(minutos) {
                 const ref = this._getBaseRef()?.child('config/antecedenciaNotificacao');
                 if (!ref) return;
                 await ref.set(minutos);
            }
        };


        // ========================================
        // GERENCIADOR DE TRATAMENTOS E DOSES
        // ========================================
        const TreatmentManager = {
            tratamentos: [],
            dosesDiarias: [],
            async init() {
                // Inicializa carregando os tratamentos e doses do paciente ativo
                this.tratamentos = await DataManager.carregarTratamentos();
                this.dosesDiarias = await DataManager.carregarDoses();
            },
            async adicionarTratamento(dados) {
                const novoTratamento = {
                    ...dados,
                    id: Date.now().toString(), // Gera um ID √∫nico simples
                    dataInicio: new Date().toISOString().split('T')[0] // Data de in√≠cio
                };
                this.tratamentos.push(novoTratamento);
                // Salva no Firebase e regenera doses
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje(); // Regenera doses ap√≥s salvar
                    await DataManager.marcarGeracaoHoje(); // Marca que as doses foram geradas hoje
                    return true;
                }
                return false; // Falha ao salvar
            },
            async editarTratamento(id, dados) {
                const index = this.tratamentos.findIndex(t => t.id === id);
                if (index === -1) return false; // Tratamento n√£o encontrado
                this.tratamentos[index] = { ...this.tratamentos[index], ...dados };
                // Salva no Firebase e regenera doses
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje(); // Regenera doses ap√≥s salvar
                    await DataManager.marcarGeracaoHoje();
                    return true;
                }
                return false; // Falha ao salvar
            },
            async excluirTratamento(id) {
                this.tratamentos = this.tratamentos.filter(t => t.id !== id);
                // Salva no Firebase e regenera doses
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje(); // Regenera doses ap√≥s excluir
                    await DataManager.marcarGeracaoHoje();
                    return true;
                }
                return false; // Falha ao salvar
            },
            async gerarDosesParaHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const doses = [];

                // Itera pelos tratamentos para gerar doses di√°rias
                this.tratamentos.forEach(trat => {
                    trat.horarios.forEach(horario => {
                        doses.push({
                            id: `${trat.id}_${horario}`, // ID √∫nico para a dose
                            remedio: trat.nome,
                            dosagem: trat.dosagem,
                            horario: horario,
                            status: 'pendente', // Status inicial
                             hoje // Data associada
                        });
                    });
                });

                this.dosesDiarias = doses;
                // Salva as doses geradas no Firebase
                await DataManager.salvarDoses(this.dosesDiarias);
            },
            obterEstatisticas() {
                const total = this.tratamentos.length;
                let ativos = 0;
                let concluidos = 0;

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0); // Zera horas para comparar apenas datas

                // Calcula estat√≠sticas com base na data de in√≠cio e dura√ß√£o
                this.tratamentos.forEach(trat => {
                    const dataInicio = new Date(trat.dataInicio);
                    dataInicio.setHours(0, 0, 0, 0);
                    const diffDays = Math.ceil((hoje - dataInicio) / 86400000); // Diferen√ßa em dias

                    if (trat.tipotratamento === 'continuo') {
                        ativos++; // Tratamentos cont√≠nuos sempre ativos
                    } else if (diffDays >= 0 && diffDays < trat.duracao) {
                        ativos++; // Tratamentos tempor√°rios dentro do prazo
                    } else if (diffDays >= trat.duracao) {
                        concluidos++; // Tratamentos tempor√°rios conclu√≠dos
                    }
                });

                return { total, ativos, concluidos };
            }
        };


        // ========================================
        // INTERFACE DO USU√ÅRIO (UI)
        // ========================================
        const UI = {
            mostrarToast(mensagem, tipo = 'info') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 ease-in-out opacity-0 translate-y-2`;
                if (tipo === 'success') toast.classList.add('bg-green-500');
                else if (tipo === 'error') toast.classList.add('bg-red-500');
                else toast.classList.add('bg-blue-500');
                toast.textContent = mensagem;
                toastContainer.appendChild(toast);
                // Anima√ß√£o de entrada
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-2');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                // Auto remove ap√≥s 3 segundos
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            validarCampo(campo, mensagemErro) {
                const errorElement = document.getElementById(`error-${campo.id}`);
                if (!campo.value.trim()) {
                    if (errorElement) errorElement.textContent = mensagemErro;
                    campo.classList.add('border-red-500');
                    return false;
                } else {
                    if (errorElement) errorElement.textContent = '';
                    campo.classList.remove('border-red-500');
                    return true;
                }
            },
            formatarData(data) {
                return data.toLocaleDateString('pt-BR');
            },
            aplicarDarkMode() {
                 // Verifica e aplica o modo escuro salvo
                 DataManager.carregarDarkMode().then(ativado => {
                      if (ativado) {
                          document.body.classList.add('dark-mode');
                          document.getElementById('toggle-dark-mode').querySelector('span').style.transform = 'translateX(1.5rem)';
                      }
                 });
            }
        };


        // ========================================
        // GERENCIADOR DE FORMUL√ÅRIOS
        // ========================================
        const FormManager = {
            validarFormulario() {
                let valido = true;
                // Valida campos obrigat√≥rios
                if (!UI.validarCampo(document.getElementById('nome-remedio'), 'Informe o nome')) valido = false;
                if (!UI.validarCampo(document.getElementById('dosagem-remedio'), 'Informe a dose')) valido = false;
                const tipoTratamento = document.getElementById('tipo-tratamento').value;
                if (tipoTratamento === 'temporario') {
                    const duracao = document.getElementById('duracao-tratamento');
                    if (!UI.validarCampo(duracao, 'Informe a dura√ß√£o')) valido = false;
                }
                // Valida se h√° hor√°rios adicionados
                const horarios = document.querySelectorAll('#horarios-container input[type="time"]');
                if (horarios.length === 0) {
                    document.getElementById('error-horarios').textContent = 'Adicione um hor√°rio';
                    document.getElementById('error-horarios').classList.remove('hidden');
                    valido = false;
                } else {
                    document.getElementById('error-horarios').classList.add('hidden');
                }
                return valido;
            },
            coletarDados() {
                 const tipo = document.getElementById('tipo-tratamento').value;
                 const instrucoesSelect = document.getElementById('instrucoes-remedio').value;
                 // Determina as instru√ß√µes com base na sele√ß√£o
                 let instrucoes = instrucoesSelect === 'personalizado' ?
                     (document.getElementById('instrucoes-personalizadas').value.trim() || 'Conforme orienta√ß√£o') :
                     instrucoesSelect;
                 // Coleta e ordena os hor√°rios
                 const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]'))
                     .map(i => i.value).filter(Boolean).sort();
                 return {
                     nome: document.getElementById('nome-remedio').value.trim(),
                     dosagem: document.getElementById('dosagem-remedio').value.trim(),
                     tipotratamento: tipo,
                     duracao: tipo === 'temporario' ? parseInt(document.getElementById('duracao-tratamento').value) : null,
                     horarios,
                     instrucoes
                 };
            },
            editarTratamento(id) {
                 const tratamento = TreatmentManager.tratamentos.find(t => t.id === id);
                 if (!tratamento) return;
                 // Preenche o formul√°rio com os dados do tratamento
                 document.getElementById('tratamento-id').value = tratamento.id;
                 document.getElementById('nome-remedio').value = tratamento.nome;
                 document.getElementById('dosagem-remedio').value = tratamento.dosagem;
                 document.getElementById('tipo-tratamento').value = tratamento.tipotratamento;
                 // Mostra/esconde campo de dura√ß√£o
                 const duracaoContainer = document.getElementById('duracao-container');
                 duracaoContainer.style.display = tratamento.tipotratamento === 'temporario' ? 'block' : 'none';
                 if (tratamento.duracao) {
                     document.getElementById('duracao-tratamento').value = tratamento.duracao;
                 }
                 // Recria os campos de hor√°rio
                 const horariosContainer = document.getElementById('horarios-container');
                 horariosContainer.innerHTML = '';
                 tratamento.horarios.forEach(horario => {
                     const input = document.createElement('input');
                     input.type = 'time';
                     input.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500';
                     input.value = horario;
                     horariosContainer.appendChild(input);
                 });
                 // Seleciona a instru√ß√£o e mostra campo personalizado se necess√°rio
                 document.getElementById('instrucoes-remedio').value = ['antes', 'depois'].includes(tratamento.instrucoes) ? tratamento.instrucoes : 'personalizado';
                 const instrucoesPersContainer = document.getElementById('instrucoes-personalizadas-container');
                 instrucoesPersContainer.style.display = ['antes', 'depois'].includes(tratamento.instrucoes) ? 'none' : 'block';
                 if (!['antes', 'depois'].includes(tratamento.instrucoes)) {
                     document.getElementById('instrucoes-personalizadas').value = tratamento.instrucoes;
                 }
                 // Alterna para a aba de tratamentos
                 document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                 document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                 document.getElementById('btn-tab-tratamentos').classList.add('active');
                 document.getElementById('tab-tratamentos').classList.add('active');
            },
            excluirTratamento(id) {
                 // Confirma antes de excluir
                 if (!confirm('Tem certeza que deseja excluir este tratamento?')) return;
                 TreatmentManager.excluirTratamento(id).then(sucesso => {
                     if (sucesso) {
                         Renderer.renderApp(); // Re-renderiza a app
                         UI.mostrarToast('Tratamento exclu√≠do com sucesso!', 'success');
                     } else {
                         UI.mostrarToast('Erro ao excluir o tratamento.', 'error');
                     }
                 });
            }
        };


        // ========================================
        // GERENCIADOR DE EXPORTA√á√ÉO
        // ========================================
        const ExportManager = {
            async exportarCSV() {
                if (TreatmentManager.tratamentos.length === 0) {
                    UI.mostrarToast('Nenhum tratamento para exportar', 'error');
                    return;
                }
                // Obt√©m o nome do paciente ativo para o nome do arquivo
                const users = await DataManager.getUsers();
                const activeUserId = DataManager.activePatientId;
                const activeUser = users.find(u => u.id === activeUserId);
                const userName = activeUser ? activeUser.name.replace(/\s/g, '_') : 'Paciente';

                let csv = 'Nome,Dosagem,Tipo,Dura√ß√£o (dias),Hor√°rios,Instru√ß√µes,Data de In√≠cio';
                TreatmentManager.tratamentos.forEach(trat => {
                    const tipo = trat.tipotratamento === 'continuo' ? 'Cont√≠nuo' : 'Tempor√°rio';
                    const duracao = trat.tipotratamento === 'continuo' ? 'N/A' : trat.duracao;
                    // Formata os hor√°rios como string separada por '; '
                    const horarios = `"${trat.horarios.join('; ')}"`;
                    const dataInicio = new Date(trat.dataInicio).toLocaleDateString('pt-BR');
                    // Adiciona linha ao CSV
                    csv += `\n"${trat.nome}","${trat.dosagem}","${tipo}","${duracao}","${horarios}","${trat.instrucoes}","${dataInicio}"`;
                });

                // Cria e faz o download do arquivo CSV
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Tratamentos_${userName}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };


        // ========================================
        // RENDERIZADOR DA INTERFACE
        // ========================================
        const Renderer = {
            async renderApp() {
                 // Verifica se h√° um paciente ativo
                 if (DataManager.activePatientId) {
                     document.getElementById('main-controls').style.display = 'flex';
                     document.getElementById('footer-progress').style.display = 'block';
                     document.getElementById('placeholder').style.display = 'none';
                     document.getElementById('checklist-container').style.display = 'block';
                     // Inicializa o gerenciador de tratamentos
                     await TreatmentManager.init();
                     this.renderDosesDiarias(); // Renderiza o checklist
                 } else {
                     // Se n√£o houver paciente, limpa e mostra placeholder
                     document.getElementById('checklist-container').innerHTML = '';
                     document.getElementById('main-controls').style.display = 'none';
                     document.getElementById('footer-progress').style.display = 'none';
                     document.getElementById('placeholder').style.display = 'block';
                     document.getElementById('checklist-container').style.display = 'none';
                 }
                 this.atualizarBarraProgresso(); // Atualiza a barra de progresso
            },
            renderPacientes(users) {
                 const container = document.getElementById('pacientes-lista');
                 container.innerHTML = ''; // Limpa o container
                 // Renderiza cada paciente
                 users.forEach(user => {
                     const card = document.createElement('div');
                     card.className = 'bg-white rounded-2xl shadow-lg overflow-hidden';
                     card.innerHTML = `
                         <div class="p-6">
                             <div class="flex justify-between items-start">
                                 <div>
                                     <h3 class="text-xl font-bold text-gray-800">${user.name}</h3>
                                     <p class="text-gray-600 text-sm mt-1">ID: ${user.id}</p>
                                 </div>
                                 <button onclick="UserManager.selecionarPaciente('${user.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">Selecionar</button>
                             </div>
                         </div>
                     `;
                     container.appendChild(card);
                 });
            },
            renderTratamentos() {
                const container = document.getElementById('tratamentos-lista');
                container.innerHTML = ''; // Limpa o container
                // Renderiza cada tratamento
                TreatmentManager.tratamentos.forEach(trat => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-2xl shadow-lg overflow-hidden';
                    // Determina o texto da dura√ß√£o
                    const duracaoTexto = trat.tipotratamento === 'continuo' ? 'Cont√≠nuo' : `${trat.duracao} dias`;
                    card.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${trat.nome} - ${trat.dosagem}</h3>
                                    <p class="text-gray-600 mt-2"><span class="font-semibold">Tipo:</span> ${duracaoTexto}</p>
                                    <p class="text-gray-600 mt-1"><span class="font-semibold">Hor√°rios:</span> ${trat.horarios.join(', ')}</p>
                                    <p class="text-gray-600 mt-1"><span class="font-semibold">Instru√ß√µes:</span> ${trat.instrucoes}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="FormManager.editarTratamento('${trat.id}')" class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition" title="Editar">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </button>
                                    <button onclick="FormManager.excluirTratamento('${trat.id}')" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" title="Excluir">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            renderDosesDiarias() {
                const container = document.getElementById('checklist-container');
                container.innerHTML = ''; // Limpa o container

                // Agrupa as doses por per√≠odo do dia
                const groupedMeds = {
                    'Manh√£ ‚òÄÔ∏è': [],
                    'Tarde üåá': [],
                    'Noite üåô': []
                };

                // Classifica as doses por hor√°rio e agrupa
                TreatmentManager.dosesDiarias
                    .sort((a, b) => a.horario.localeCompare(b.horario))
                    .forEach(dose => {
                        const hour = parseInt(dose.horario.split(':')[0], 10);
                        if (hour >= 4 && hour < 12) {
                            groupedMeds['Manh√£ ‚òÄÔ∏è'].push(dose);
                        } else if (hour >= 12 && hour < 18) {
                            groupedMeds['Tarde üåá'].push(dose);
                        } else {
                            groupedMeds['Noite üåô'].push(dose);
                        }
                    });

                // Renderiza cada per√≠odo
                for (const periodo in groupedMeds) {
                    if (groupedMeds[periodo].length > 0) {
                        const periodCard = document.createElement('div');
                        periodCard.className = 'bg-white rounded-2xl shadow-lg overflow-hidden';
                        periodCard.innerHTML = `
                            <div class="bg-gray-50 p-4 border-b border-gray-200">
                                <h2 class="text-lg font-bold text-gray-800">${periodo}</h2>
                            </div>
                            <div class="p-4">
                        `;
                        // Renderiza cada dose dentro do per√≠odo
                        groupedMeds[periodo].forEach(dose => {
                            const doseCard = document.createElement('div');
                            doseCard.className = 'p-3 border border-gray-200 rounded-lg mb-3 bg-gray-50';
                            doseCard.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">${dose.remedio}</p>
                                        <p class="text-gray-600 text-sm">${dose.dosagem}</p>
                                        <p class="text-gray-500 text-xs mt-1">${dose.horario}</p>
                                    </div>
                                    <button onclick="Renderer.marcarDose('${dose.id}')" class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-medium">
                                        Tomada
                                    </button>
                                </div>
                            `;
                            periodCard.appendChild(doseCard);
                        });
                        periodCard.innerHTML += '</div></div>';
                        container.appendChild(periodCard);
                    }
                }
                this.atualizarBarraProgresso(); // Atualiza a barra ap√≥s renderizar
            },
            marcarDose(id) {
                // Encontra a dose e marca como 'tomada'
                const dose = TreatmentManager.dosesDiarias.find(d => d.id === id);
                if (dose) {
                    dose.status = 'tomada';
                    DataManager.salvarDoses(TreatmentManager.dosesDiarias).then(() => {
                        this.renderDosesDiarias(); // Re-renderiza o checklist
                        UI.mostrarToast('Dose marcada como tomada!', 'success');
                    });
                }
            },
            atualizarBarraProgresso() {
                const total = TreatmentManager.dosesDiarias.length;
                const tomadas = TreatmentManager.dosesDiarias.filter(d => d.status === 'tomada').length;
                const percentual = total > 0 ? Math.round((tomadas / total) * 100) : 0;

                document.getElementById('progress-text').textContent = `${percentual}%`;
                document.getElementById('progress-bar').style.width = `${percentual}%`;
            }
        };


        // ========================================
        // GERENCIADOR DE NOTIFICA√á√ï√ïES
        // ========================================
        const NotificationManager = {
            intervalId: null,
            async solicitarPermissao() {
                if (!('Notification' in window)) {
                    UI.mostrarToast('Seu navegador n√£o suporta notifica√ß√µes', 'error');
                    return false;
                }
                if (Notification.permission === 'granted') return true;
                if (Notification.permission === 'denied') return false;
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            },
            enviarNotificacao(titulo, corpo) {
                if (Notification.permission !== 'granted') return;
                try {
                    // Tenta enviar a notifica√ß√£o
                    const notification = new Notification(titulo, {
                        body: corpo,
                        icon: 'favicon.ico' // Substitua pelo caminho correto do seu favicon
                    });
                } catch (err) {
                    console.error('Erro ao enviar notifica√ß√£o:', err);
                }
            },
            async verificarDoses() {
                 // Verifica se as notifica√ß√µes est√£o ativadas
                 const notificacoesAtivadas = await DataManager.carregarNotificacoes();
                 if (!notificacoesAtivadas) return;

                 const agora = new Date();
                 const horaAtual = agora.getHours();
                 const minutoAtual = agora.getMinutes();
                 // Carrega a anteced√™ncia configurada
                 const antecedencia = await DataManager.carregarAntecedencia();

                 // Verifica cada dose pendente
                 for (const dose of TreatmentManager.dosesDiarias) {
                     if (dose.status !== 'pendente') continue; // Pula doses j√° tomadas

                     const [horaDose, minutoDose] = dose.horario.split(':').map(Number);
                     const diferencaMinutos = (horaDose * 60 + minutoDose) - (horaAtual * 60 + minutoAtual);

                     // Se a dose est√° dentro da janela de anteced√™ncia, envia notifica√ß√£o
                     if (diferencaMinutos > 0 && diferencaMinutos <= antecedencia) {
                         this.enviarNotificacao(
                             `üíä Hora do Rem√©dio: ${dose.remedio}`,
                             `√â hora de tomar ${dose.dosagem} de ${dose.remedio} √†s ${dose.horario}.`
                         );
                         // Marca a dose como notificada para evitar repeti√ß√µes
                         dose.notified = true;
                         await DataManager.salvarDoses(TreatmentManager.dosesDiarias);
                     }
                 }
            },
            iniciarVerificacao() {
                 // Inicia a verifica√ß√£o peri√≥dica a cada minuto
                 this.intervalId = setInterval(() => {
                     this.verificarDoses();
                 }, 60 * 1000); // 60 segundos
                 this.verificarDoses(); // Executa uma verifica√ß√£o imediata ao iniciar
            },
            pararVerificacao() {
                 // Limpa o intervalo de verifica√ß√£o
                 if (this.intervalId) {
                     clearInterval(this.intervalId);
                     this.intervalId = null;
                 }
            }
        };


        // ========================================
        // GERENCIADOR DE USU√ÅRIOS/PACIENTES
        // ========================================
        const UserManager = {
             async carregarPacientes() {
                 const users = await DataManager.getUsers();
                 Renderer.renderPacientes(users); // Renderiza a lista de pacientes
             },
             async selecionarPaciente(id) {
                  await DataManager.setActivePatientId(id); // Define o paciente ativo
                  await Renderer.renderApp(); // Re-renderiza a app com o novo paciente
                  UI.mostrarToast('Paciente selecionado com sucesso!', 'success');
             }
        };


        // ========================================
        // INICIALIZA√á√ÉO E EVENT LISTENERS GLOBAIS
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
             // Listener para mudan√ßas no estado de autentica√ß√£o
             auth.onAuthStateChanged(async (user) => {
                 if (user) {
                     // Verifica se o usu√°rio est√° bloqueado antes de prosseguir
                     const userRef = database.ref(`users_public_list/${user.uid}`);
                     const snapshot = await userRef.once('value');
                     const userData = snapshot.val();
                     if (userData && userData.isBlocked) {
                         // Usu√°rio bloqueado: mostra tela de acesso negado
                         document.getElementById('auth-container').style.display = 'flex';
                         document.getElementById('app-container').style.display = 'none';
                         document.querySelector('#auth-container p').textContent = 'Sua conta est√° bloqueada. Contate o administrador.';
                         return; // Interrompe a inicializa√ß√£o
                     }

                     // Usu√°rio v√°lido: inicializa a app
                     document.getElementById('auth-container').style.display = 'none';
                     document.getElementById('app-container').style.display = 'block';
                     document.getElementById('user-email').textContent = user.email;

                     // Inicializa o DataManager com o UID do usu√°rio
                     await DataManager.init(user.uid);
                     await UI.aplicarDarkMode(); // Aplica o modo escuro salvo
                     await UserManager.carregarPacientes(); // Carrega a lista de pacientes

                     // Verifica e inicia notifica√ß√µes se estiverem ativadas
                     const notificacoesAtivadas = await DataManager.carregarNotificacoes();
                     if (notificacoesAtivadas) {
                         const permitido = await NotificationManager.solicitarPermissao();
                         if (permitido) {
                             NotificationManager.iniciarVerificacao();
                         }
                     }
                     document.getElementById('current-date').textContent = UI.formatarData(new Date());
                 } else {
                     // Usu√°rio n√£o autenticado: mostra tela de acesso negado
                     document.getElementById('app-container').style.display = 'none';
                     document.getElementById('auth-container').style.display = 'flex';
                 }
             });

             // Logout
             document.getElementById('logout-btn').addEventListener('click', () => {
                 auth.signOut();
             });

            // --- Navega√ß√£o por Abas ---
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove classe 'active' de todos os bot√µes e conte√∫dos
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    // Adiciona classe 'active' ao bot√£o clicado e √† aba correspondente
                    button.classList.add('active');
                    document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');
                });
            });

            // --- Aba Pacientes ---
            document.getElementById('salvar-paciente-btn').addEventListener('click', async () => {
                 const nomeInput = document.getElementById('nome-paciente');
                 const nome = nomeInput.value.trim();
                 if (!nome) {
                     UI.mostrarToast('Por favor, informe o nome do paciente.', 'error');
                     return;
                 }
                 // Gera um ID √∫nico para o novo paciente
                 const novoId = `paciente_${Date.now()}`;
                 const novoPaciente = {
                     id: novoId,
                     name: nome
                 };
                 // Salva o novo paciente no Firebase
                 const ref = database.ref(`easy_lists/${DataManager.uid}/enfermeiro_inteligente/patients/${novoId}`);
                 await ref.set(novoPaciente);
                 nomeInput.value = ''; // Limpa o campo de input
                 await UserManager.carregarPacientes(); // Recarrega a lista
                 UI.mostrarToast('Paciente criado com sucesso!', 'success');
            });

            // --- Aba Tratamentos ---
            document.getElementById('tipo-tratamento').addEventListener('change', function() {
                const duracaoContainer = document.getElementById('duracao-container');
                // Mostra/esconde o campo de dura√ß√£o com base no tipo de tratamento
                duracaoContainer.style.display = this.value === 'temporario' ? 'block' : 'none';
            });

            document.getElementById('adicionar-horario-btn').addEventListener('click', () => {
                const container = document.getElementById('horarios-container');
                // Adiciona um novo campo de input para hor√°rio
                const input = document.createElement('input');
                input.type = 'time';
                input.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500';
                container.appendChild(input);
            });

            document.getElementById('instrucoes-remedio').addEventListener('change', function() {
                const container = document.getElementById('instrucoes-personalizadas-container');
                // Mostra/esconde o campo de instru√ß√µes personalizadas
                container.style.display = this.value === 'personalizado' ? 'block' : 'none';
            });

            document.getElementById('salvar-tratamento-btn').addEventListener('click', async (e) => {
                e.preventDefault(); // Previne o comportamento padr√£o do formul√°rio
                if (!FormManager.validarFormulario()) {
                    UI.mostrarToast('Preencha os campos obrigat√≥rios.', 'error');
                    return;
                }
                const id = document.getElementById('tratamento-id').value;
                const dados = FormManager.coletarDados();
                let sucesso;
                // Adiciona ou edita o tratamento com base na presen√ßa do ID
                if (id) {
                    sucesso = await TreatmentManager.editarTratamento(id, dados);
                } else {
                    sucesso = await TreatmentManager.adicionarTratamento(dados);
                }
                if (sucesso) {
                    await Renderer.renderApp(); // Re-renderiza a app
                    // Limpa o formul√°rio
                    document.getElementById('tratamento-id').value = '';
                    document.getElementById('nome-remedio').value = '';
                    document.getElementById('dosagem-remedio').value = '';
                    document.getElementById('tipo-tratamento').value = 'temporario';
                    document.getElementById('duracao-container').style.display = 'none';
                    document.getElementById('duracao-tratamento').value = '';
                    document.getElementById('horarios-container').innerHTML = '';
                    document.getElementById('instrucoes-remedio').value = 'antes';
                    document.getElementById('instrucoes-personalizadas-container').style.display = 'none';
                    document.getElementById('instrucoes-personalizadas').value = '';
                    UI.mostrarToast('Tratamento salvo com sucesso!', 'success');
                } else {
                    UI.mostrarToast('Erro ao salvar o tratamento.', 'error');
                }
            });

            document.getElementById('cancelar-tratamento-btn').addEventListener('click', () => {
                 // Limpa o formul√°rio ao cancelar
                 document.getElementById('tratamento-id').value = '';
                 document.getElementById('nome-remedio').value = '';
                 document.getElementById('dosagem-remedio').value = '';
                 document.getElementById('tipo-tratamento').value = 'temporario';
                 document.getElementById('duracao-container').style.display = 'none';
                 document.getElementById('duracao-tratamento').value = '';
                 document.getElementById('horarios-container').innerHTML = '';
                 document.getElementById('instrucoes-remedio').value = 'antes';
                 document.getElementById('instrucoes-personalizadas-container').style.display = 'none';
                 document.getElementById('instrucoes-personalizadas').value = '';
            });

            // --- Aba Relat√≥rios ---
            document.getElementById('exportar-csv-btn').addEventListener('click', async () => {
                 await ExportManager.exportarCSV();
            });

            // --- Aba Configura√ß√µes ---
            document.getElementById('toggle-dark-mode').addEventListener('click', async () => {
                 const button = document.getElementById('toggle-dark-mode');
                 const span = button.querySelector('span');
                 const estaAtivado = document.body.classList.contains('dark-mode');
                 // Alterna o estado do modo escuro
                 document.body.classList.toggle('dark-mode');
                 if (estaAtivado) {
                     span.style.transform = 'translateX(0.25rem)';
                     await DataManager.salvarDarkMode(false);
                 } else {
                     span.style.transform = 'translateX(1.5rem)';
                     await DataManager.salvarDarkMode(true);
                 }
            });

            document.getElementById('toggle-notifications').addEventListener('click', async function() {
                 const estaAtivado = this.dataset.enabled === 'true';
                 if (!estaAtivado) {
                     // Solicita permiss√£o ao ativar notifica√ß√µes
                     const permitido = await NotificationManager.solicitarPermissao();
                     if (permitido) {
                         this.dataset.enabled = 'true';
                         this.classList.add('bg-blue-600');
                         this.querySelector('span').style.transform = 'translateX(1.5rem)';
                         document.getElementById('notification-settings').classList.remove('hidden');
                         await DataManager.salvarNotificacoes(true);
                         NotificationManager.iniciarVerificacao(); // Inicia a verifica√ß√£o
                         UI.mostrarToast('Notifica√ß√µes ativadas!', 'success');
                     } else {
                         UI.mostrarToast('Permiss√£o n√£o concedida.', 'error');
                     }
                 } else {
                     // Desativa notifica√ß√µes
                     this.dataset.enabled = 'false';
                     this.classList.remove('bg-blue-600');
                     this.querySelector('span').style.transform = 'translateX(0.25rem)';
                     document.getElementById('notification-settings').classList.add('hidden');
                     await DataManager.salvarNotificacoes(false);
                     NotificationManager.pararVerificacao(); // Para a verifica√ß√£o
                     UI.mostrarToast('Notifica√ß√µes desativadas.', 'info');
                 }
            });

            document.getElementById('select-antecedencia').addEventListener('change', async function() {
                 // Salva a nova anteced√™ncia selecionada
                 await DataManager.salvarAntecedencia(parseInt(this.value));
                 UI.mostrarToast('Anteced√™ncia atualizada.', 'info');
            });

            document.getElementById('btn-testar-notificacao').addEventListener('click', () => {
                 // Testa o envio de notifica√ß√£o se permitido
                 if (Notification.permission === 'granted') {
                     NotificationManager.enviarNotificacao('üíä Teste', 'Notifica√ß√µes est√£o funcionando!');
                 } else {
                     UI.mostrarToast('Permiss√£o para notifica√ß√µes n√£o concedida.', 'error');
                 }
            });

            // --- Bot√µes Flutuantes (Checklist) ---
            document.getElementById('btn-finalizar-dia').addEventListener('click', async () => {
                 if (!DataManager.activePatientId) {
                     UI.mostrarToast('Nenhum paciente selecionado.', 'error');
                     return;
                 }
                 // Verifica se h√° doses antes de finalizar
                 if (TreatmentManager.dosesDiarias.length === 0) {
                     UI.mostrarToast('Nenhuma dose registrada para hoje.', 'info');
                     return;
                 }
                 const confirmacao = confirm("Tem certeza que deseja finalizar o dia? Isso marcar√° todas as doses restantes como 'n√£o tomadas'.");
                 if (confirmacao) {
                     // Marca todas as doses pendentes como 'n√£o tomadas'
                     TreatmentManager.dosesDiarias.forEach(dose => {
                         if (dose.status === 'pendente') {
                             dose.status = 'nao_tomada';
                         }
                     });
                     await DataManager.salvarDoses(TreatmentManager.dosesDiarias);
                     await Renderer.renderApp(); // Re-renderiza
                     UI.mostrarToast('Dia finalizado. Doses restantes marcadas como \'n√£o tomadas\'.', 'success');
                 }
            });

            document.getElementById('btn-gerar-relatorio').addEventListener('click', () => {
                 if (!DataManager.activePatientId) {
                     UI.mostrarToast('Nenhum paciente selecionado.', 'error');
                     return;
                 }
                 // Verifica se h√° dados para gerar o relat√≥rio
                 if (TreatmentManager.tratamentos.length === 0 && TreatmentManager.dosesDiarias.length === 0) {
                     UI.mostrarToast('Nenhum dado para gerar relat√≥rio.', 'info');
                     return;
                 }
                 let reportText = `RELAT√ìRIO DE TRATAMENTO\n========================\n\n`;
                 const users = DataManager.getUsers();
                 const activeUserId = DataManager.activePatientId;
                 const activeUser = users.find(u => u.id === activeUserId);
                 const userName = activeUser ? activeUser.name : 'Paciente Desconhecido';
                 reportText += `Paciente: ${userName}\n`;
                 reportText += `Data: ${new Date().toLocaleString('pt-BR')}\n\n`;

                 // Adiciona estat√≠sticas ao relat√≥rio
                 const stats = TreatmentManager.obterEstatisticas();
                 reportText += `--- ESTAT√çSTICAS ---\n`;
                 reportText += `Total de Tratamentos: ${stats.total}\n`;
                 reportText += `Tratamentos Ativos: ${stats.ativos}\n`;
                 reportText += `Tratamentos Conclu√≠dos: ${stats.concluidos}\n\n`;

                 // Adiciona lista de tratamentos
                 reportText += `--- TRATAMENTOS CADASTRADOS (${TreatmentManager.tratamentos.length}) ---\n`;
                 if (TreatmentManager.tratamentos.length === 0) {
                     reportText += `Nenhum tratamento cadastrado.\n\n`;
                 } else {
                     TreatmentManager.tratamentos.forEach((trat, index) => {
                         const tipo = trat.tipotratamento === 'continuo' ? 'Cont√≠nuo' : `Tempor√°rio (${trat.duracao} dias)`;
                         reportText += `${index + 1}. ${trat.nome} - ${trat.dosagem}\n`;
                         reportText += `   Tipo: ${tipo}\n`;
                         reportText += `   Hor√°rios: ${trat.horarios.join(', ')}\n`;
                         reportText += `   Instru√ß√µes: ${trat.instrucoes}\n`;
                         reportText += `   In√≠cio: ${new Date(trat.dataInicio).toLocaleDateString('pt-BR')}\n\n`;
                     });
                 }

                 // Adiciona doses de hoje
                 reportText += `--- DOSES DE HOJE (${TreatmentManager.dosesDiarias.length}) ---\n`;
                 if (TreatmentManager.dosesDiarias.length === 0) {
                     reportText += `Nenhuma dose programada para hoje.\n`;
                 } else {
                     const statusCounts = { pendente: 0, tomada: 0, nao_tomada: 0 };
                     TreatmentManager.dosesDiarias.forEach(dose => {
                         statusCounts[dose.status]++;
                         const statusText = dose.status === 'pendente' ? 'Pendente' : dose.status === 'tomada' ? 'Tomada' : 'N√£o Tomada';
                         reportText += `- ${dose.remedio} (${dose.dosagem}) √†s ${dose.horario} [${statusText}]\n`;
                     });
                     reportText += `\nResumo dos Status:\n`;
                     reportText += `Pendentes: ${statusCounts.pendente}\n`;
                     reportText += `Tomadas: ${statusCounts.tomada}\n`;
                     reportText += `N√£o Tomadas: ${statusCounts.nao_tomada}\n`;
                 }

                 // Exibe o relat√≥rio em um modal
                 const modalBody = document.getElementById('modal-body');
                 modalBody.innerHTML = `<pre class="whitespace-pre-wrap">${reportText}</pre>`;
                 document.getElementById('modal-title').textContent = 'Relat√≥rio de Tratamento';
                 document.getElementById('modal-actions').innerHTML = `
                     <button id="btn-copy-report" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Copiar</button>
                     <button id="btn-close-modal" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Fechar</button>
                 `;
                 document.getElementById('modal-overlay').classList.remove('hidden');

                 // Adiciona listener para o bot√£o de copiar
                 document.getElementById('btn-copy-report').onclick = () => {
                     navigator.clipboard.writeText(reportText).then(() => {
                         UI.mostrarToast('Relat√≥rio copiado para a √°rea de transfer√™ncia!', 'success');
                     }, (err) => {
                         console.error('Erro ao copiar: ', err);
                         UI.mostrarToast('Falha ao copiar o relat√≥rio.', 'error');
                     });
                 };
            });

            // --- Modal ---
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('modal-overlay').classList.add('hidden');
            });
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'modal-overlay') {
                    document.getElementById('modal-overlay').classList.add('hidden');
                }
            });
            // Listener para fechar o modal atrav√©s do bot√£o dentro das a√ß√µes
            document.getElementById('modal-actions').addEventListener('click', (e) => {
                 if (e.target.id === 'btn-close-modal') {
                     document.getElementById('modal-overlay').classList.add('hidden');
                 }
            });

        });
    </script>
</body>
</html>