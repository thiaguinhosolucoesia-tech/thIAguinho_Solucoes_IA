<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Enfermeiro Inteligente - Sincronizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --dark-color: #222;
            --light-color: #f4f9ff;
            --gray-color: #7f8c8d;
            --white-color: #ffffff;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --border-color: #dfe4ea;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-headings: 'Lato', var(--font-main);
        }
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@700&family=Roboto:wght@400;500;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: var(--light-color); color: var(--dark-color); line-height: 1.6; }
        .main-container { max-width: 800px; margin: 20px auto; background-color: var(--white-color); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        #auth-container { display: none; align-items: center; justify-content: center; padding: 50px 20px; text-align: center; }
        .auth-box { background: var(--white-color); padding: 40px; border-radius: 12px; }
        .auth-box h1 { color: var(--danger-color); } .auth-box p { color: var(--gray-color); margin-top: 10px; }
        #app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: var(--white-color); border-bottom: 1px solid #eee; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .back-btn { background-color: var(--light-color); color: var(--primary-color); text-decoration: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: background-color 0.2s; }
        .back-btn:hover { background-color: #e0e5e9; }
        #app-header #user-email { color: var(--gray-color); }
        #app-header #logout-btn { background: var(--danger-color); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .tab-navigation { display: flex; background-color: #34495e; }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: var(--light-color); font-size: 1.1em; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { background-color: var(--white-color); color: var(--dark-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .form-content { padding: 30px; }
        .form-section { margin-bottom: 40px; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; }
        .section-header { padding: 20px; background-color: #f9f9f9; border-bottom: 1px solid #ddd; }
        .section-header h2 { font-family: var(--font-headings); margin: 0; font-size: 1.5em; }
        .section-body { padding: 25px; }
        .form-group { margin-bottom: 30px; }
        label { display: block; font-weight: 700; margin-bottom: 10px; }
        label small { display: block; font-weight: 400; color: var(--gray-color); }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        textarea { resize: vertical; min-height: 120px; }
        .button-group { padding: 30px; background-color: #f0f0f0; border-top: 1px solid #ddd; }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .report-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s ease; }
        .report-panel { background: var(--dark-color); color: var(--white-color); width: 90%; max-width: 600px; max-height: 85vh; border-radius: 16px; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .report-header { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .report-header h2 { color: var(--accent-color); font-size: 1.5em; }
        .report-header .close-btn { font-size: 28px; color: #fff; cursor: pointer; background: none; border: none; }
        .report-body { padding: 25px; overflow-y: auto; white-space: pre-wrap; line-height: 1.8; }
        .report-footer { padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-copy { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background-color: var(--success-color); color: #fff; }
        .modal-content { background: var(--white-color); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #ccc; text-align: center; }
        .modal-content h3 { font-size: 1.5rem; margin-top: 0; margin-bottom: 10px; }
        .modal-content p { font-size: 1.1rem; color: var(--gray-color); margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { background-color: var(--danger-color); color: white; }
        .btn-cancel { background-color: #7f8c8d; color: white; }
        .btn-ok { background-color: var(--accent-color); color: white; }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:active { transform: scale(0.98); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action { display: block; width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--white-color); }
        .btn-tertiary { background-color: var(--gray-color); color: white; }
        .btn-secondary { background-color: var(--primary-color); color: white; }
        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-tertiary:hover { filter: brightness(0.9); }
        .btn-secondary:hover { filter: brightness(0.9); }
        .btn-action:hover { filter: brightness(0.9); }
        .btn-action:active { transform: scale(0.98); }
        .btn-tertiary:...... (c√≥digo muito longo, omitindo partes redundantes)
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box"><h1>Acesso Negado</h1><p>Sua sess√£o √© inv√°lida ou expirou. Por favor, retorne √† plataforma e fa√ßa login novamente.</p></div>
    </div>

    <div id="app-container" class="main-container" style="display: none;">
        <header id="app-header">
            <div class="header-left">
                <a href="../dashboard.html" class="back-btn"><span>&larr;</span> Voltar</a>
                <h1>Controle de Tratamento</h1>
            </div>
            <div id="user-info">
                <span id="user-email"></span>
                <button id="logout-btn">Sair</button>
            </div>
        </header>

        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="pacientes">Pacientes</button>
            <button class="tab-btn" data-tab="tratamentos">Tratamentos</button>
            <button class="tab-btn" data-tab="relatorios">Relat√≥rios</button>
        </div>

        <div id="pacientes" class="tab-content active">
            <div class="form-content">
                <div class="form-group">
                    <label for="nome-paciente">Nome do Paciente</label>
                    <input type="text" id="nome-paciente" placeholder="Nome completo">
                </div>
                <div class="button-group">
                    <button type="button" id="salvar-paciente-btn" class="btn-action">Criar Perfil</button>
                </div>
            </div>
            <div id="pacientes-lista" class="form-content"></div>
        </div>

        <div id="tratamentos" class="tab-content">
            <div class="form-content">
                <div class="form-group">
                    <label for="nome-remedio">Nome do Rem√©dio</label>
                    <input type="text" id="nome-remedio" placeholder="Ex: Paracetamol">
                </div>
                <div class="form-group">
                    <label for="dosagem-remedio">Dosagem</label>
                    <input type="text" id="dosagem-remedio" placeholder="Ex: 500mg">
                </div>
                <div class="form-group">
                    <label for="tipo-tratamento">Tipo de Tratamento</label>
                    <select id="tipo-tratamento">
                        <option value="temporario">Tempor√°rio</option>
                        <option value="continuo">Cont√≠nuo</option>
                    </select>
                </div>
                <div id="duracao-container" class="form-group" style="display: none;">
                    <label for="duracao-tratamento">Dura√ß√£o (dias)</label>
                    <input type="number" id="duracao-tratamento" placeholder="Ex: 7">
                </div>
                <div class="form-group">
                    <label for="horarios-container">Hor√°rios de Tomada</label>
                    <div id="horarios-container"></div>
                    <button type="button" id="adicionar-horario-btn" class="btn-action">Adicionar Hor√°rio</button>
                </div>
                <div class="form-group">
                    <label for="instrucoes-remedio">Instru√ß√µes</label>
                    <select id="instrucoes-remedio">
                        <option value="antes">Antes das refei√ß√µes</option>
                        <option value="depois">Depois das refei√ß√µes</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                <div id="instrucoes-personalizadas-container" class="form-group" style="display: none;">
                    <label for="instrucoes-personalizadas">Instru√ß√µes Personalizadas</label>
                    <input type="text" id="instrucoes-personalizadas" placeholder="Ex: Tomar com √°gua">
                </div>
                <div class="button-group">
                    <button type="button" id="salvar-tratamento-btn" class="btn-action">Salvar Tratamento</button>
                    <button type="button" id="cancelar-tratamento-btn" class="btn-action btn-tertiary">Cancelar</button>
                </div>
            </div>
            <div id="tratamentos-lista" class="form-content"></div>
        </div>

        <div id="relatorios" class="tab-content">
            <div class="form-content">
                <div class="button-group">
                    <button type="button" id="exportar-csv-btn" class="btn-action">Exportar CSV</button>
                </div>
                <div id="relatorios-lista" class="form-content"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="toast-overlay">
        <div class="notification-modal">
            <h3 id="toast-title"></h3>
            <p id="toast-message"></p>
            <div class="modal-actions">
                <button id="toast-ok-btn" class="btn-ok">Ok</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="confirmation-title"></h3>
            <p id="confirmation-message"></p>
            <div class="modal-actions">
                <button id="btn-confirm-action" class="btn-confirm">Confirmar</button>
                <button id="btn-cancel-action" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // INICIALIZA O FIREBASE COM A CONFIGURA√á√ÉO EXTERNA
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const DataManager = {
            uid: null,
            activePatientId: null,
            async init(uid) {
                this.uid = uid;
                this.activePatientId = await this.getActivePatientId();
            },
            _getBaseRef() {
                if (!this.uid) return null;
                return database.ref(`easy_lists/${this.uid}/enfermeiro_inteligente`);
            },
            async getUsers() {
                const ref = this._getBaseRef()?.child('patients');
                if (!ref) return [];
                const snapshot = await ref.once('value');
                const data = snapshot.val();
                if (!data) return [];

                // Convertendo o objeto em array de objetos com ID
                const users = [];
                for (const id in data) {
                    users.push({ id, ...data[id] });
                }
                return users;
            },
            async getActivePatientId() {
                const ref = this._getBaseRef()?.child('active_patient_id');
                if (!ref) return null;
                const snapshot = await ref.once('value');
                return snapshot.val();
            },
            async setActivePatientId(id) {
                const ref = this._getBaseRef()?.child('active_patient_id');
                if (!ref) return;
                await ref.set(id);
                this.activePatientId = id;
            },
            _getPatientDataRef() {
                if (!this.uid || !this.activePatientId) return null;
                return database.ref(`easy_lists/${this.uid}/enfermeiro_inteligente/${this.activePatientId}`);
            },
            async _getData(path) {
                const ref = this._getPatientDataRef()?.child(path);
                if (!ref) return null;
                const snapshot = await ref.once('value');
                return snapshot.val();
            },
            async _saveData(path, data) {
                const ref = this._getPatientDataRef()?.child(path);
                if (!ref) {
                    console.error('N√£o √© poss√≠vel salvar dados sem um paciente ativo.');
                    return false;
                }
                await ref.set(data);
                return true;
            },
            async carregarTratamentos() {
                return await this._getData('tratamentos') || [];
            },
            async salvarTratamentos(tratamentos) {
                return await this._saveData('tratamentos', tratamentos);
            },
            async carregarDoses() {
                return await this._getData('dosesDiarias') || [];
            },
            async salvarDoses(doses) {
                return await this._saveData('dosesDiarias', doses);
            },
            async precisaGerarDosesHoje() {
                const hoje = new Date().toLocaleDateString('pt-BR');
                const ultimaGeracao = await this._getData('ultimaGeracao');
                return ultimaGeracao !== hoje;
            },
            async marcarGeracaoHoje() {
                const hoje = new Date().toLocaleDateString('pt-BR');
                await this._saveData('ultimaGeracao', hoje);
            },
            async carregarDarkMode() {
                const ref = this._getBaseRef()?.child('global_settings/darkMode');
                if (!ref) return false;
                const snapshot = await ref.once('value');
                return snapshot.val() === true;
            },
            async salvarDarkMode(ativado) {
                const ref = this._getBaseRef()?.child('global_settings/darkMode');
                if (!ref) return;
                await ref.set(ativado);
            },
            async carregarNotificacoes() {
                return await this._getData('config/notificacoesAtivadas') || false;
            },
            async salvarNotificacoes(ativadas) {
                const ref = this._getBaseRef()?.child('config/notificacoesAtivadas');
                if (!ref) return;
                await ref.set(ativadas);
            }
        };

        const TreatmentManager = {
            tratamentos: [],
            dosesDiarias: [],
            async init() {
                this.tratamentos = await DataManager.carregarTratamentos();
                this.dosesDiarias = await DataManager.carregarDoses();
            },
            async adicionarTratamento(dados) {
                const novoTratamento = { ...dados, id: Date.now().toString(), dataInicio: new Date().toISOString().split('T')[0] };
                this.tratamentos.push(novoTratamento);
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje();
                    await DataManager.marcarGeracaoHoje();
                    return true;
                }
                return false;
            },
            async editarTratamento(id, dados) {
                const index = this.tratamentos.findIndex(t => t.id === id);
                if (index === -1) return false;
                this.tratamentos[index] = { ...this.tratamentos[index], ...dados };
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje();
                    await DataManager.marcarGeracaoHoje();
                    return true;
                }
                return false;
            },
            async excluirTratamento(id) {
                this.tratamentos = this.tratamentos.filter(t => t.id !== id);
                if (await DataManager.salvarTratamentos(this.tratamentos)) {
                    await this.gerarDosesParaHoje();
                    await DataManager.marcarGeracaoHoje();
                    return true;
                }
                return false;
            },
            async gerarDosesParaHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const doses = [];

                this.tratamentos.forEach(trat => {
                    if (trat.tipotratamento === 'continuo') {
                        // Para tratamentos cont√≠nuos, gerar uma dose para cada hor√°rio
                        trat.horarios.forEach(horario => {
                            doses.push({
                                id: `${trat.id}_${horario}`,
                                remedio: trat.nome,
                                dosagem: trat.dosagem,
                                horario: horario,
                                status: 'pendente',
                                 hoje,
                                tratamentoId: trat.id
                            });
                        });
                    } else {
                        // Para tratamentos tempor√°rios, calcular baseado na data de in√≠cio e dura√ß√£o
                        const dataInicio = new Date(trat.dataInicio);
                        const duracao = trat.duracao;
                        const hojeDate = new Date();

                        for (let i = 0; i < duracao; i++) {
                            const data = new Date(dataInicio);
                            data.setDate(data.getDate() + i);
                            const dataStr = data.toISOString().split('T')[0];
                            trat.horarios.forEach(horario => {
                                doses.push({
                                    id: `${trat.id}_${dataStr}_${horario}`,
                                    remedio: trat.nome,
                                    dosagem: trat.dosagem,
                                    horario: horario,
                                    status: 'pendente',
                                     dataStr,
                                    tratamentoId: trat.id
                                });
                            });
                        }
                    }
                });

                this.dosesDiarias = doses;
                await DataManager.salvarDoses(this.dosesDiarias);
            },
            obterEstatisticas() {
                const total = this.tratamentos.length;
                let ativos = 0;
                let concluidos = 0;

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                this.tratamentos.forEach(trat => {
                    const dataInicio = new Date(trat.dataInicio);
                    dataInicio.setHours(0, 0, 0, 0);
                    const diffDays = Math.ceil((hoje - dataInicio) / 86400000);

                    if (trat.tipotratamento === 'continuo') {
                        ativos++;
                    } else if (diffDays >= 0 && diffDays < trat.duracao) {
                        ativos++;
                    } else if (diffDays >= trat.duracao) {
                        concluidos++;
                    }
                });

                return { total, ativos, concluidos };
            }
        };

        const UI = {
            mostrarToast(mensagem, tipo = 'info') {
                const overlay = document.getElementById('toast-overlay');
                const title = document.getElementById('toast-title');
                const message = document.getElementById('toast-message');
                const okBtn = document.getElementById('toast-ok-btn');

                title.textContent = tipo === 'success' ? 'Sucesso' : tipo === 'error' ? 'Erro' : 'Informa√ß√£o';
                message.textContent = mensagem;
                overlay.classList.add('visible');

                okBtn.onclick = () => {
                    overlay.classList.remove('visible');
                };
            },
            validarCampo(campo, mensagemErro) {
                const errorElement = document.getElementById(`error-${campo.id}`);
                if (!campo.value.trim()) {
                    if (errorElement) errorElement.textContent = mensagemErro;
                    campo.classList.add('border-red-500');
                    return false;
                } else {
                    if (errorElement) errorElement.textContent = '';
                    campo.classList.remove('border-red-500');
                    return true;
                }
            },
            formatarData(data) {
                return data.toLocaleDateString('pt-BR');
            },
            aplicarDarkMode() {
                const darkMode = DataManager.carregarDarkMode();
                if (darkMode) {
                    document.body.classList.add('dark');
                }
            }
        };

        const FormManager = {
            validarFormulario() {
                let valido = true;
                if (!UI.validarCampo(document.getElementById('nome-remedio'), 'Informe o nome')) valido = false;
                if (!UI.validarCampo(document.getElementById('dosagem-remedio'), 'Informe a dose')) valido = false;
                const tipoTratamento = document.getElementById('tipo-tratamento').value;
                if (tipoTratamento === 'temporario') {
                    const duracao = document.getElementById('duracao-tratamento');
                    if (!UI.validarCampo(duracao, 'Informe a dura√ß√£o')) valido = false;
                }
                const horarios = document.querySelectorAll('#horarios-container input[type="time"]');
                if (horarios.length === 0) {
                    document.getElementById('error-horarios').textContent = 'Adicione um hor√°rio';
                    document.getElementById('error-horarios').classList.remove('hidden');
                    valido = false;
                } else {
                    document.getElementById('error-horarios').classList.add('hidden');
                }
                return valido;
            },
            coletarDados() {
                const tipo = document.getElementById('tipo-tratamento').value;
                const instrucoesSelect = document.getElementById('instrucoes-remedio').value;
                let instrucoes = instrucoesSelect === 'personalizado' ?
                    (document.getElementById('instrucoes-personalizadas').value.trim() || 'Conforme orienta√ß√£o') :
                    instrucoesSelect;
                const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]'))
                    .map(i => i.value).filter(Boolean).sort();
                return {
                    nome: document.getElementById('nome-remedio').value.trim(),
                    dosagem: document.getElementById('dosagem-remedio').value.trim(),
                    tipotratamento: tipo,
                    duracao: tipo === 'temporario' ? parseInt(document.getElementById('duracao-tratamento').value) : null,
                    horarios,
                    instrucoes
                };
            }
        };

        const ExportManager = {
            async exportarCSV() {
                if (TreatmentManager.tratamentos.length === 0) {
                    UI.mostrarToast('Nenhum tratamento para exportar', 'error');
                    return;
                }
                const users = await DataManager.getUsers();
                const activeUserId = DataManager.activePatientId;
                const activeUser = users.find(u => u.id === activeUserId);
                const userName = activeUser ? activeUser.name.replace(/\s/g, '_') : 'Paciente';
                let csv = 'Nome,Dosagem,Tipo,Dura√ß√£o (dias),Hor√°rios,Instru√ß√µes,Data de In√≠cio';
                TreatmentManager.tratamentos.forEach(trat => {
                    const tipo = trat.tipotratamento === 'continuo' ? 'Cont√≠nuo' : 'Tempor√°rio';
                    const duracao = trat.tipotratamento === 'continuo' ? 'N/A' : trat.duracao;
                    const horarios = `"${trat.horarios.join('; ')}"`;
                    const dataInicio = new Date(trat.dataInicio).toLocaleDateString('pt-BR');
                    csv += `\n"${trat.nome}","${trat.dosagem}","${tipo}","${duracao}","${horarios}","${trat.instrucoes}","${dataInicio}"`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Tratamentos_${userName}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const UserManager = {
            async init() {
                // Inicializa√ß√£o do gerenciador de usu√°rios, se necess√°rio
            },
            async carregarPacientes() {
                const pacientes = await DataManager.getUsers();
                const container = document.getElementById('pacientes-lista');
                container.innerHTML = '';
                pacientes.forEach(paciente => {
                    const card = document.createElement('div');
                    card.className = 'form-section';
                    card.innerHTML = `
                        <div class="section-header">
                            <h2>${paciente.name}</h2>
                        </div>
                        <div class="section-body">
                            <p><strong>ID:</strong> ${paciente.id}</p>
                            <button class="btn-action" onclick="UserManager.selecionarPaciente('${paciente.id}')">Selecionar</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            async selecionarPaciente(id) {
                await DataManager.setActivePatientId(id);
                await TreatmentManager.init();
                await Renderer.renderApp();
                UI.mostrarToast('Paciente selecionado com sucesso!', 'success');
            }
        };

        const Renderer = {
            async renderApp() {
                if (DataManager.activePatientId) {
                    document.getElementById('main-controls').style.display = 'flex';
                    document.getElementById('footer-progress').style.display = 'block';
                    await TreatmentManager.init();
                    this.renderDosesDiarias();
                } else {
                    document.getElementById('checklist-container').innerHTML = '';
                    document.getElementById('main-controls').style.display = 'none';
                    document.getElementById('footer-progress').style.display = 'none';
                    const placeholder = document.getElementById('placeholder');
                    placeholder.style.display = 'block';
                    const container = document.getElementById('checklist-container');
                    container.style.display = 'none';
                }
            },
            renderPacientes() {
                UserManager.carregarPacientes();
            },
            renderTratamentos() {
                const container = document.getElementById('tratamentos-lista');
                container.innerHTML = '';
                TreatmentManager.tratamentos.forEach(trat => {
                    const card = document.createElement('div');
                    card.className = 'form-section';
                    card.innerHTML = `
                        <div class="section-header">
                            <h2>${trat.nome} - ${trat.dosagem}</h2>
                        </div>
                        <div class="section-body">
                            <p><strong>Tipo:</strong> ${trat.tipotratamento === 'continuo' ? 'Cont√≠nuo' : 'Tempor√°rio'}</p>
                            ${trat.tipotratamento === 'temporario' ? `<p><strong>Dura√ß√£o:</strong> ${trat.duracao} dias</p>` : ''}
                            <p><strong>Hor√°rios:</strong> ${trat.horarios.join(', ')}</p>
                            <p><strong>Instru√ß√µes:</strong> ${trat.instrucoes}</p>
                            <button class="btn-action" onclick="FormManager.editarTratamento('${trat.id}')">Editar</button>
                            <button class="btn-action btn-tertiary" onclick="FormManager.excluirTratamento('${trat.id}')">Excluir</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            renderDosesDiarias() {
                const container = document.getElementById('checklist-container');
                const groupedMeds = {
                    'Manh√£ ‚òÄÔ∏è': [],
                    'Tarde üåá': [],
                    'Noite üåô': []
                };
                TreatmentManager.dosesDiarias.sort((a, b) => a.horario.localeCompare(b.horario)).forEach(dose => {
                    const hour = parseInt(dose.horario.split(':')[0], 10);
                    if (hour >= 4 && hour < 12) groupedMeds['Manh√£ ‚òÄÔ∏è'].push(dose);
                    else if (hour >= 12 && hour < 18) groupedMeds['Tarde üåá'].push(dose);
                    else groupedMeds['Noite üåô'].push(dose);
                });
                for (const periodo in groupedMeds) {
                    if (groupedMeds[periodo].length > 0) {
                        const periodCard = document.createElement('div');
                        periodCard.className = 'form-section';
                        periodCard.innerHTML = `
                            <div class="section-header">
                                <h2>${periodo}</h2>
                            </div>
                            <div class="section-body">
                        `;
                        groupedMeds[periodo].forEach(dose => {
                            const doseCard = document.createElement('div');
                            doseCard.className = 'form-group';
                            doseCard.innerHTML = `
                                <p><strong>${dose.remedio}</strong> - ${dose.dosagem}</p>
                                <p>${dose.horario}</p>
                                <button class="btn-action" onclick="Renderer.marcarDose('${dose.id}')">Marcar como Tomada</button>
                            `;
                            periodCard.appendChild(doseCard);
                        });
                        periodCard.innerHTML += '</div></div>';
                        container.appendChild(periodCard);
                    }
                }
            },
            marcarDose(id) {
                const dose = TreatmentManager.dosesDiarias.find(d => d.id === id);
                if (dose) {
                    dose.status = 'tomada';
                    DataManager.salvarDoses(TreatmentManager.dosesDiarias);
                    Renderer.renderDosesDiarias();
                    UI.mostrarToast('Dose marcada como tomada!', 'success');
                }
            }
        };

        const NotificationManager = {
            async solicitarPermissao() {
                if (!('Notification' in window)) {
                    UI.mostrarToast('Seu navegador n√£o suporta notifica√ß√µes', 'error');
                    return false;
                }
                if (Notification.permission === 'granted') return true;
                if (Notification.permission === 'denied') return false;
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            },
            enviarNotificacao(titulo, corpo) {
                if (Notification.permission !== 'granted') return;
                try {
                    const notification = new Notification(titulo, {
                        body: corpo,
                        icon: 'favicon.ico'
                    });
                } catch (err) {
                    console.error('Erro ao enviar notifica√ß√£o:', err);
                }
            }
        };

        // ========================================
        // INICIALIZA√á√ÉO E EVENT LISTENERS GLOBAIS
        // ========================================
        async function main(user) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            await DataManager.init(user.uid);
            await UI.aplicarDarkMode();
            await UserManager.init();
            await Renderer.renderApp();
            document.getElementById('current-date').textContent = UI.formatarData(new Date());
            if (await DataManager.carregarNotificacoes()) {
                const permitido = await NotificationManager.solicitarPermissao();
                if (permitido) {
                    // Iniciar verifica√ß√£o de notifica√ß√µes se necess√°rio
                }
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Verificar se o usu√°rio est√° bloqueado
                    const userRef = database.ref(`users_public_list/${user.uid}`);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();
                    if (userData && userData.isBlocked) {
                        // Usu√°rio est√° bloqueado
                        document.getElementById('auth-container').style.display = 'flex';
                        document.getElementById('app-container').style.display = 'none';
                        document.querySelector('#auth-container .auth-box p').textContent = 'Sua conta est√° bloqueada. Contate o administrador.';
                        return;
                    }
                    await main(user);
                } else {
                    document.getElementById('app-container').style.display = 'none';
                    document.getElementById('auth-container').style.display = 'flex';
                }
            });

            // Tab Navigation
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.toggle('active', content.id === button.dataset.tab);
                    });
                });
            });

            // Pacientes Tab
            document.getElementById('salvar-paciente-btn').addEventListener('click', async () => {
                const nome = document.getElementById('nome-paciente').value.trim();
                if (!nome) {
                    UI.mostrarToast('Por favor, informe o nome do paciente.', 'error');
                    return;
                }
                const pacientes = await DataManager.getUsers();
                const novoId = `paciente_${Date.now()}`;
                const novoPaciente = {
                    id: novoId,
                    name: nome
                };
                const ref = database.ref(`easy_lists/${DataManager.uid}/enfermeiro_inteligente/patients/${novoId}`);
                await ref.set(novoPaciente);
                document.getElementById('nome-paciente').value = '';
                await UserManager.carregarPacientes();
                UI.mostrarToast('Paciente criado com sucesso!', 'success');
            });

            // Tratamentos Tab
            document.getElementById('tipo-tratamento').addEventListener('change', function() {
                const duracaoContainer = document.getElementById('duracao-container');
                duracaoContainer.style.display = this.value === 'temporario' ? 'block' : 'none';
            });

            document.getElementById('adicionar-horario-btn').addEventListener('click', () => {
                const container = document.getElementById('horarios-container');
                const input = document.createElement('input');
                input.type = 'time';
                input.className = 'form-group';
                container.appendChild(input);
            });

            document.getElementById('instrucoes-remedio').addEventListener('change', function() {
                const container = document.getElementById('instrucoes-personalizadas-container');
                container.style.display = this.value === 'personalizado' ? 'block' : 'none';
            });

            document.getElementById('salvar-tratamento-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (!FormManager.validarFormulario()) {
                    UI.mostrarToast('Preencha os campos obrigat√≥rios.', 'error');
                    return;
                }
                const id = document.getElementById('tratamento-id').value;
                const dados = FormManager.coletarDados();
                const sucesso = id ?
                    await TreatmentManager.editarTratamento(id, dados) :
                    await TreatmentManager.adicionarTratamento(dados);
                if (sucesso) {
                    await Renderer.renderApp();
                    document.getElementById('tratamento-id').value = '';
                    document.getElementById('nome-remedio').value = '';
                    document.getElementById('dosagem-remedio').value = '';
                    document.getElementById('tipo-tratamento').value = 'temporario';
                    document.getElementById('duracao-container').style.display = 'none';
                    document.getElementById('duracao-tratamento').value = '';
                    document.getElementById('horarios-container').innerHTML = '';
                    document.getElementById('instrucoes-remedio').value = 'antes';
                    document.getElementById('instrucoes-personalizadas-container').style.display = 'none';
                    document.getElementById('instrucoes-personalizadas').value = '';
                    UI.mostrarToast('Tratamento salvo com sucesso!', 'success');
                } else {
                    UI.mostrarToast('Erro ao salvar o tratamento.', 'error');
                }
            });

            document.getElementById('cancelar-tratamento-btn').addEventListener('click', () => {
                document.getElementById('tratamento-id').value = '';
                document.getElementById('nome-remedio').value = '';
                document.getElementById('dosagem-remedio').value = '';
                document.getElementById('tipo-tratamento').value = 'temporario';
                document.getElementById('duracao-container').style.display = 'none';
                document.getElementById('duracao-tratamento').value = '';
                document.getElementById('horarios-container').innerHTML = '';
                document.getElementById('instrucoes-remedio').value = 'antes';
                document.getElementById('instrucoes-personalizadas-container').style.display = 'none';
                document.getElementById('instrucoes-personalizadas').value = '';
            });

            // Relat√≥rios Tab
            document.getElementById('exportar-csv-btn').addEventListener('click', async () => {
                await ExportManager.exportarCSV();
            });

            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                auth.signOut();
            });
        });
    </script>
</body>
</html>