<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Enfermeiro Inteligente - Sincronizado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs - Usando compat versions para compatibilidade -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Nosso arquivo de configuraÃ§Ã£o do Firebase -->
    <script src="firebase-config.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .dark-mode { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .btn-principal, .btn-secundario, .btn-icon { transition: all 0.2s ease-in-out; }
        .btn-principal:active, .btn-secundario:active, .btn-icon:active { transform: scale(0.95); filter: brightness(0.9); }
        .fade-in-scale { animation: fadeInScale 0.4s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .card-concluido { background-color: #e8f5e9; border-left-color: #4caf50; opacity: 0.8; }
        .dark-mode .card-concluido { background-color: #2f4431; border-left-color: #66bb6a; }
        .card-concluido .info-remedio { text-decoration: line-through; color: #555; }
        .dark-mode .card-concluido .info-remedio { color: #a0aec0; }
        .card-atrasado { border-left-color: #f44336; background-color: #ffebee; }
        .dark-mode .card-atrasado { background-color: #5c2b2b; border-left-color: #ef5350; }
        .card-proximo { border-left-color: #ff9800; background-color: #fff3e0; animation: pulse 2s infinite; }
        .dark-mode .card-proximo { background-color: #6d4c22; border-left-color: #ffa726; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { background-color: #4caf50; color: white; }
        .toast-error { background-color: #f44336; color: white; }
        .toast-info { background-color: #2196f3; color: white; }
        .input-error { border-color: #f44336 !important; background-color: #ffebee !important; }
        .error-message { color: #f44336; font-size: 0.875rem; margin-top: 0.25rem; }
        @media print { body * { visibility: hidden; } #relatorio-imprimir, #relatorio-imprimir * { visibility: visible; } #relatorio-imprimir { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
        .dark-mode .bg-white { background-color: #2d3748 !important; color: #e2e8f0; }
        .dark-mode .bg-gray-50 { background-color: #262f3d !important; }
        .dark-mode .bg-gray-100 { background-color: #374151 !important; }
        .dark-mode .bg-gray-200 { background-color: #4a5568 !important; }
        .dark-mode .text-gray-900 { color: #e2e8f0 !important; }
        .dark-mode .text-gray-600 { color: #cbd5e0 !important; }
        .dark-mode .text-gray-500 { color: #a0aec0 !important; }
        .dark-mode .text-gray-400 { color: #718096 !important; }
        .dark-mode .border-gray-300 { border-color: #4a5568 !important; }
        .dark-mode .bg-blue-50 { background-color: #2c3a57 !important; }
        .dark-mode .bg-purple-50 { background-color: #3c3658 !important; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: #f44336; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body class="text-gray-900">
    <div id="auth-container" class="fixed inset-0 bg-gray-100 flex items-center justify-center" style="display: none;">
        <div class="text-center p-8 bg-white rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-red-600">Acesso Negado</h1>
            <p class="text-gray-600 mt-2">Sua sessÃ£o Ã© invÃ¡lida ou expirou. Por favor, retorne Ã  plataforma e faÃ§a login novamente.</p>
        </div>
    </div>

    <div id="app-container" style="display: none;" class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-8 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <a href="../dashboard.html" class="p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition no-print" title="Voltar ao Dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    </a>
                    <h1 class="text-2xl sm:text-4xl font-bold text-blue-800">ðŸ’Š Meu Enfermeiro Inteligente</h1>
                </div>
                <div class="flex gap-2">
                    <button id="btn-toggle-dark" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition" title="Alternar modo escuro"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button>
                    <button id="btn-notifications" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition relative" title="Configurar notificaÃ§Ãµes (em breve)"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg><span id="notification-badge" class="notification-badge hidden">0</span></button>
                    <button id="logout-btn" class="btn-icon p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition" title="Sair"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-blue-50 rounded-lg flex flex-col sm:flex-row items-center gap-4">
                <label for="user-selector" class="text-lg font-semibold text-blue-800">Paciente:</label>
                <select id="user-selector" class="flex-grow mt-1 w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 transition"></select>
                <button id="btn-manage-users" class="btn-secundario bg-white text-blue-600 border-2 border-blue-500 font-bold py-2 px-4 rounded-full shadow-sm text-md hover:bg-blue-50 transition">Gerenciar</button>
            </div>
            <p class="text-gray-600 text-lg mt-4">Hoje Ã© <span id="current-date" class="font-semibold"></span></p>
        </header>

        <div id="main-controls" class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-10">
            <button id="btn-open-modal" class="btn-principal bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg text-xl flex items-center gap-3 w-full sm:w-auto hover:bg-blue-700 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>Adicionar Tratamento</button>
            <button id="btn-open-relatorio" class="btn-secundario bg-white text-blue-600 border-2 border-blue-500 font-bold py-3 px-6 rounded-full shadow-sm text-lg flex items-center gap-3 w-full sm:w-auto hover:bg-blue-50 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Ver RelatÃ³rio</button>
        </div>
        <main id="checklist-container" class="space-y-10"></main>
        <div id="placeholder" class="text-center bg-white/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl mt-10"><div id="placeholder-icon" class="text-6xl mb-4">ðŸ‘¥</div><p id="placeholder-title" class="mt-4 text-xl text-gray-600 font-semibold">Selecione ou crie um perfil de paciente para comeÃ§ar.</p><p id="placeholder-subtitle" class="text-gray-500 mt-2">Use o menu "Paciente" acima para gerenciar os perfis.</p></div>
        <footer id="footer-progress" class="mt-12 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl"><h3 class="text-xl font-semibold mb-3 text-center">Progresso do Dia</h3><div class="w-full bg-gray-200 rounded-full h-6 shadow-inner overflow-hidden"><div id="progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-6 rounded-full transition-all duration-500 flex items-center justify-center text-white font-bold text-sm" style="width: 0%"></div></div><p id="progress-text" class="text-lg text-gray-600 mt-3 text-center"></p><div id="next-dose-info" class="mt-4 p-4 bg-blue-50 rounded-lg text-center hidden"><p class="text-sm text-gray-600">PrÃ³xima dose:</p><p class="text-lg font-bold text-blue-700" id="next-dose-text"></p></div></footer>
        <div class="mt-8 text-center text-white/80 text-sm"><p>Desenvolvido com IA por thIAguinho SoluÃ§Ãµes</p></div>
    </div>
    
    <div id="modal-adicionar-remedio" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-lg shadow-lg fade-in-scale">
            <h2 class="text-2xl font-bold mb-6 text-blue-800">Adicionar Novo Tratamento</h2>
            <form id="form-remedio" class="space-y-4">
                <div><label for="nome-remedio" class="block text-sm font-medium text-gray-700">Nome do RemÃ©dio:</label><input type="text" id="nome-remedio" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div><label for="dosagem" class="block text-sm font-medium text-gray-700">Dosagem (ex: 500mg):</label><input type="text" id="dosagem" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="intervalo" class="block text-sm font-medium text-gray-700">Intervalo (horas):</label><input type="number" id="intervalo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="1" required></div>
                <div><label for="data-inicio" class="block text-sm font-medium text-gray-700">Data de InÃ­cio:</label><input type="date" id="data-inicio" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div><label for="hora-primeira-dose" class="block text-sm font-medium text-gray-700">Hora da Primeira Dose:</label><input type="time" id="hora-primeira-dose" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div class="flex justify-end gap-4"><button type="button" id="btn-cancelar-remedio" class="btn-secundario bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-400 transition">Cancelar</button><button type="submit" class="btn-principal bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition">Adicionar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-relatorio" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-lg shadow-lg fade-in-scale">
            <h2 class="text-2xl font-bold mb-6 text-blue-800">RelatÃ³rio de Tratamento</h2>
            <div id="relatorio-imprimir" class="mb-4 p-4 border rounded-md bg-gray-50 overflow-y-auto max-h-96">
                <h3 class="text-xl font-semibold mb-2">Resumo Geral</h3>
                <p id="relatorio-resumo"></p>
                <h3 class="text-xl font-semibold mt-4 mb-2">Detalhes por RemÃ©dio</h3>
                <div id="relatorio-detalhes"></div>
            </div>
            <div class="flex justify-end gap-4 no-print"><button type="button" id="btn-imprimir-relatorio" class="btn-secundario bg-green-600 text-white font-bold py-2 px-4 rounded-full hover:bg-green-700 transition">Imprimir</button><button type="button" id="btn-fechar-relatorio" class="btn-secundario bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-400 transition">Fechar</button></div>
        </div>
    </div>

    <div id="modal-manage-users" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
        <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-lg shadow-lg fade-in-scale">
            <h2 class="text-2xl font-bold mb-6 text-blue-800">Gerenciar Pacientes</h2>
            <div id="patient-list" class="space-y-3 mb-6"></div>
            <form id="form-add-patient" class="space-y-4">
                <h3 class="text-xl font-semibold text-gray-700">Adicionar Novo Paciente</h3>
                <div><label for="new-patient-name" class="block text-sm font-medium text-gray-700">Nome do Paciente:</label><input type="text" id="new-patient-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div class="flex justify-end gap-4"><button type="submit" class="btn-principal bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition">Adicionar Paciente</button></div>
            </form>
            <div class="flex justify-end gap-4 mt-6"><button type="button" id="btn-close-manage-users" class="btn-secundario bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-400 transition">Fechar</button></div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let currentPatientId = null;
        let patientsRef = null;
        let remediosRef = null;

        // VariÃ¡veis para controle do modo escuro
        const toggleDarkBtn = document.getElementById('btn-toggle-dark');
        const htmlElement = document.documentElement;

        // FunÃ§Ã£o para aplicar ou remover o modo escuro
        function toggleDarkMode() {
            if (htmlElement.classList.contains('dark-mode')) {
                htmlElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            } else {
                htmlElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Verifica o tema preferido do usuÃ¡rio ao carregar a pÃ¡gina
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark-mode');
        }

        // Event listener para o botÃ£o de alternar modo escuro
        toggleDarkBtn.addEventListener('click', toggleDarkMode);

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                patientsRef = database.ref(`enfermeiro_inteligente/${currentUserId}/patients`);
                
                // Atualiza o status online do usuÃ¡rio
                const userOnlineRef = database.ref("users_online/" + user.uid);
                userOnlineRef.set({ email: user.email, lastOnline: new Date().toISOString() });
                userOnlineRef.onDisconnect().remove();

                document.getElementById('app-container').style.display = 'block';
                document.getElementById('auth-container').style.display = 'none';
                loadPatients();
            } else {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('auth-container').style.display = 'flex';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (currentUserId) {
                database.ref("users_online/" + currentUserId).remove(); // Remove o status online ao deslogar
            }
            auth.signOut().then(() => {
                window.location.replace('../index.html');
            });
        });

        document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        async function loadPatients() {
            patientsRef.on('value', (snapshot) => {
                const patients = snapshot.val();
                const userSelector = document.getElementById('user-selector');
                userSelector.innerHTML = '';
                const patientListDiv = document.getElementById('patient-list');
                patientListDiv.innerHTML = '';

                if (!patients) {
                    document.getElementById('placeholder').style.display = 'block';
                    document.getElementById('checklist-container').innerHTML = '';
                    document.getElementById('footer-progress').style.display = 'none';
                    return;
                }

                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('footer-progress').style.display = 'block';

                let firstPatientId = null;
                for (let id in patients) {
                    if (!firstPatientId) firstPatientId = id;
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = patients[id].name;
                    userSelector.appendChild(option);

                    // Adiciona Ã  lista de gerenciamento de pacientes
                    const patientItem = document.createElement('div');
                    patientItem.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-md';
                    patientItem.innerHTML = `
                        <span>${patients[id].name}</span>
                        <button class="text-red-500 hover:text-red-700" onclick="deletePatient('${id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    patientListDiv.appendChild(patientItem);
                }

                if (currentPatientId && patients[currentPatientId]) {
                    userSelector.value = currentPatientId;
                } else if (firstPatientId) {
                    currentPatientId = firstPatientId;
                    userSelector.value = firstPatientId;
                }
                userSelector.dispatchEvent(new Event('change'));
            });
        }

        document.getElementById('user-selector').addEventListener('change', (e) => {
            currentPatientId = e.target.value;
            if (currentPatientId) {
                remediosRef = database.ref(`enfermeiro_inteligente/${currentUserId}/patients/${currentPatientId}/remedios`);
                loadRemedios();
            } else {
                document.getElementById('checklist-container').innerHTML = '';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('footer-progress').style.display = 'none';
            }
        });

        document.getElementById('btn-manage-users').addEventListener('click', () => {
            document.getElementById('modal-manage-users').style.display = 'flex';
        });

        document.getElementById('btn-close-manage-users').addEventListener('click', () => {
            document.getElementById('modal-manage-users').style.display = 'none';
        });

        document.getElementById('form-add-patient').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPatientName = document.getElementById('new-patient-name').value;
            if (newPatientName && currentUserId) {
                const newPatientRef = patientsRef.push();
                await newPatientRef.set({ id: newPatientRef.key, name: newPatientName, createdAt: new Date().toISOString() });
                document.getElementById('new-patient-name').value = '';
                showToast('Paciente adicionado com sucesso!', 'success');
            }
        });

        async function deletePatient(patientId) {
            if (!confirm('Tem certeza que deseja excluir este paciente e todos os seus tratamentos?')) return;
            try {
                await patientsRef.child(patientId).remove();
                showToast('Paciente excluÃ­do com sucesso!', 'success');
                if (currentPatientId === patientId) {
                    currentPatientId = null;
                }
                loadPatients(); // Recarrega a lista de pacientes
            } catch (error) {
                console.error('Erro ao excluir paciente:', error);
                showToast('Erro ao excluir paciente.', 'error');
            }
        }

        function loadRemedios() {
            if (!remediosRef) return;

            remediosRef.on('value', (snapshot) => {
                const remedios = snapshot.val();
                const checklistContainer = document.getElementById('checklist-container');
                checklistContainer.innerHTML = '';
                let totalDoses = 0;
                let dosesTomadas = 0;
                let nextDoseTime = null;
                let nextDoseRemedio = null;
                let atrasadosCount = 0;

                if (!remedios) {
                    checklistContainer.innerHTML = '<p class="text-center text-gray-600 text-lg">Nenhum tratamento adicionado para este paciente.</p>';
                    updateProgressBar(0, 0);
                    document.getElementById('next-dose-info').classList.add('hidden');
                    document.getElementById('notification-badge').classList.add('hidden');
                    return;
                }

                const remediosArray = Object.values(remedios);
                remediosArray.sort((a, b) => new Date(a.dataInicio + 'T' + a.horaPrimeiraDose).getTime() - new Date(b.dataInicio + 'T' + b.horaPrimeiraDose).getTime());

                remediosArray.forEach(remedio => {
                    const remedioCard = document.createElement('div');
                    remedioCard.className = 'bg-white rounded-xl shadow-lg p-6 mb-4 border-l-4 border-blue-500 fade-in-scale';
                    
                    const dosesHoje = calcularDosesHoje(remedio);
                    totalDoses += dosesHoje.total;
                    dosesTomadas += dosesHoje.tomadas;

                    const agora = new Date();
                    let statusClass = '';
                    let statusText = '';
                    let proximaDose = null;

                    if (remedio.doses && remedio.doses[agora.toISOString().slice(0, 10)]) {
                        const dosesDoDia = remedio.doses[agora.toISOString().slice(0, 10)];
                        const horariosDoses = Object.keys(dosesDoDia).sort();
                        
                        for (const horario of horariosDoses) {
                            const doseTime = new Date(agora.toISOString().slice(0, 10) + 'T' + horario);
                            if (!dosesDoDia[horario].tomada && doseTime > agora) {
                                if (!proximaDose || doseTime < proximaDose) {
                                    proximaDose = doseTime;
                                    nextDoseTime = doseTime;
                                    nextDoseRemedio = remedio.nome;
                                }
                                break; // Encontrou a prÃ³xima dose, pode parar
                            }
                            if (!dosesDoDia[horario].tomada && doseTime < agora) {
                                atrasadosCount++;
                            }
                        }
                    }

                    if (dosesHoje.tomadas === dosesHoje.total && dosesHoje.total > 0) {
                        statusClass = 'card-concluido';
                        statusText = 'ConcluÃ­do';
                    } else if (atrasadosCount > 0) {
                        statusClass = 'card-atrasado';
                        statusText = 'Atrasado';
                    } else if (proximaDose) {
                        statusClass = 'card-proximo';
                        statusText = 'PrÃ³ximo';
                    } else {
                        statusText = 'Pendente';
                    }

                    remedioCard.classList.add(statusClass);

                    remedioCard.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-blue-700">${remedio.nome}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusClass === 'card-concluido' ? 'bg-green-100 text-green-800' : statusClass === 'card-atrasado' ? 'bg-red-100 text-red-800' : statusClass === 'card-proximo' ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">${statusText}</span>
                        </div>
                        <div class="info-remedio text-gray-700 mb-4">
                            <p><strong>Dosagem:</strong> ${remedio.dosagem || 'NÃ£o especificado'}</p>
                            <p><strong>Intervalo:</strong> ${remedio.intervalo} horas</p>
                            <p><strong>InÃ­cio:</strong> ${new Date(remedio.dataInicio).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4" id="doses-${remedio.id}"></div>
                        <div class="flex justify-end gap-2">
                            <button class="text-blue-500 hover:text-blue-700" onclick="editRemedio('${remedio.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" /></svg>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteRemedio('${remedio.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    checklistContainer.appendChild(remedioCard);
                    renderDoses(remedio.id, remedio.intervalo, remedio.dataInicio, remedio.horaPrimeiraDose, remedio.doses);
                });

                updateProgressBar(dosesTomadas, totalDoses);
                updateNextDoseInfo(nextDoseTime, nextDoseRemedio);
                updateNotificationBadge(atrasadosCount);
            });
        }

        function calcularDosesHoje(remedio) {
            const hojeStr = new Date().toISOString().slice(0, 10);
            const dosesDoDia = remedio.doses && remedio.doses[hojeStr] ? remedio.doses[hojeStr] : {};
            const horariosGerados = gerarHorariosDoses(remedio.dataInicio, remedio.horaPrimeiraDose, remedio.intervalo);
            
            let total = 0;
            let tomadas = 0;

            for (const horario of horariosGerados) {
                const doseTime = new Date(hojeStr + 'T' + horario);
                const agora = new Date();
                if (doseTime.toISOString().slice(0, 10) === hojeStr) { // Garante que a dose Ã© para hoje
                    total++;
                    if (dosesDoDia[horario] && dosesDoDia[horario].tomada) {
                        tomadas++;
                    }
                }
            }
            return { total, tomadas };
        }

        function gerarHorariosDoses(dataInicioStr, horaPrimeiraDoseStr, intervaloHoras) {
            const horarios = [];
            const dataInicio = new Date(dataInicioStr + 'T' + horaPrimeiraDoseStr);
            const agora = new Date();
            const hojeStr = agora.toISOString().slice(0, 10);

            // Se a data de inÃ­cio for futura, nÃ£o gera doses para hoje ainda
            if (new Date(dataInicioStr) > new Date(hojeStr)) {
                return [];
            }

            let currentDoseTime = new Date(dataInicio);
            // Ajusta currentDoseTime para o dia de hoje, mantendo a hora
            currentDoseTime.setFullYear(agora.getFullYear(), agora.getMonth(), agora.getDate());

            // Se a primeira dose original do dia jÃ¡ passou, avanÃ§a para a prÃ³xima
            if (currentDoseTime < dataInicio && new Date(dataInicioStr).toISOString().slice(0, 10) === hojeStr) {
                // Se a primeira dose do dia original jÃ¡ passou, mas Ã© o dia de inÃ­cio, usa a hora original
            } else if (currentDoseTime < dataInicio) {
                // Se nÃ£o Ã© o dia de inÃ­cio e a hora da primeira dose do dia jÃ¡ passou, ajusta para o prÃ³ximo intervalo
                while (currentDoseTime < agora) {
                    currentDoseTime.setHours(currentDoseTime.getHours() + intervaloHoras);
                }
                currentDoseTime.setHours(currentDoseTime.getHours() - intervaloHoras); // Volta para a primeira dose vÃ¡lida de hoje
            }

            // Garante que a primeira dose gerada para hoje nÃ£o seja antes da hora da primeira dose original se for o dia de inÃ­cio
            if (new Date(dataInicioStr).toISOString().slice(0, 10) === hojeStr && currentDoseTime.getHours() < dataInicio.getHours()) {
                currentDoseTime.setHours(dataInicio.getHours());
                currentDoseTime.setMinutes(dataInicio.getMinutes());
            }

            // Gera horÃ¡rios para o dia atual
            for (let i = 0; i < 24 / intervaloHoras + 1; i++) { // +1 para garantir que pega todas as doses
                const doseTime = new Date(currentDoseTime.getTime() + i * intervaloHoras * 60 * 60 * 1000);
                if (doseTime.toISOString().slice(0, 10) === hojeStr) {
                    horarios.push(doseTime.toTimeString().slice(0, 5));
                }
            }
            return horarios.sort();
        }

        function renderDoses(remedioId, intervalo, dataInicioStr, horaPrimeiraDoseStr, dosesRegistradas) {
            const dosesContainer = document.getElementById(`doses-${remedioId}`);
            dosesContainer.innerHTML = '';
            const hojeStr = new Date().toISOString().slice(0, 10);
            const dosesDoDia = dosesRegistradas && dosesRegistradas[hojeStr] ? dosesRegistradas[hojeStr] : {};
            const horariosGerados = gerarHorariosDoses(dataInicioStr, horaPrimeiraDoseStr, intervalo);

            horariosGerados.forEach(horario => {
                const doseTime = new Date(hojeStr + 'T' + horario);
                const agora = new Date();
                const tomada = dosesDoDia[horario] && dosesDoDia[horario].tomada;
                const atrasada = !tomada && doseTime < agora;

                const button = document.createElement('button');
                button.className = `py-2 px-3 rounded-lg text-sm font-semibold transition ${tomada ? 'bg-green-500 text-white' : atrasada ? 'bg-red-500 text-white' : 'bg-blue-100 text-blue-800 hover:bg-blue-200'}`;
                button.textContent = horario;
                button.disabled = tomada; // Desabilita o botÃ£o se a dose jÃ¡ foi tomada
                if (!tomada) {
                    button.onclick = () => toggleDoseTomada(remedioId, horario, !tomada);
                }
                dosesContainer.appendChild(button);
            });
        }

        async function toggleDoseTomada(remedioId, horario, tomada) {
            const hojeStr = new Date().toISOString().slice(0, 10);
            const doseRef = remediosRef.child(`${remedioId}/doses/${hojeStr}/${horario}`);
            await doseRef.set({ tomada: tomada, timestamp: new Date().toISOString() });
            showToast(`Dose das ${horario} ${tomada ? 'registrada' : 'desmarcada'}!`, 'info');
        }

        function updateProgressBar(dosesTomadas, totalDoses) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const percentage = totalDoses > 0 ? (dosesTomadas / totalDoses) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${Math.round(percentage)}%`;
            progressText.textContent = `${dosesTomadas} de ${totalDoses} doses tomadas hoje.`;
        }

        function updateNextDoseInfo(nextDoseTime, nextDoseRemedio) {
            const nextDoseInfoDiv = document.getElementById('next-dose-info');
            const nextDoseText = document.getElementById('next-dose-text');

            if (nextDoseTime && nextDoseRemedio) {
                nextDoseInfoDiv.classList.remove('hidden');
                nextDoseText.textContent = `${nextDoseRemedio} Ã s ${nextDoseTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                nextDoseInfoDiv.classList.add('hidden');
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        document.getElementById('btn-open-modal').addEventListener('click', () => {
            document.getElementById('modal-adicionar-remedio').style.display = 'flex';
        });

        document.getElementById('btn-cancelar-remedio').addEventListener('click', () => {
            document.getElementById('modal-adicionar-remedio').style.display = 'none';
            document.getElementById('form-remedio').reset();
        });

        document.getElementById('form-remedio').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('nome-remedio').value;
            const dosagem = document.getElementById('dosagem').value;
            const intervalo = parseInt(document.getElementById('intervalo').value);
            const dataInicio = document.getElementById('data-inicio').value;
            const horaPrimeiraDose = document.getElementById('hora-primeira-dose').value;

            if (nome && intervalo && dataInicio && horaPrimeiraDose && currentPatientId) {
                const newRemedioRef = remediosRef.push();
                await newRemedioRef.set({
                    id: newRemedioRef.key,
                    nome,
                    dosagem,
                    intervalo,
                    dataInicio,
                    horaPrimeiraDose,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('modal-adicionar-remedio').style.display = 'none';
                document.getElementById('form-remedio').reset();
                showToast('Tratamento adicionado com sucesso!', 'success');
            } else {
                showToast('Por favor, preencha todos os campos obrigatÃ³rios.', 'error');
            }
        });

        async function deleteRemedio(remedioId) {
            if (!confirm('Tem certeza que deseja excluir este tratamento?')) return;
            try {
                await remediosRef.child(remedioId).remove();
                showToast('Tratamento excluÃ­do com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir tratamento:', error);
                showToast('Erro ao excluir tratamento.', 'error');
            }
        }

        async function editRemedio(remedioId) {
            // Implementar lÃ³gica de ediÃ§Ã£o aqui, talvez abrindo o modal com os dados preenchidos
            showToast('Funcionalidade de ediÃ§Ã£o em desenvolvimento!', 'info');
        }

        document.getElementById('btn-open-relatorio').addEventListener('click', () => {
            generateRelatorio();
            document.getElementById('modal-relatorio').style.display = 'flex';
        });

        document.getElementById('btn-fechar-relatorio').addEventListener('click', () => {
            document.getElementById('modal-relatorio').style.display = 'none';
        });

        document.getElementById('btn-imprimir-relatorio').addEventListener('click', () => {
            window.print();
        });

        function generateRelatorio() {
            const relatorioResumo = document.getElementById('relatorio-resumo');
            const relatorioDetalhes = document.getElementById('relatorio-detalhes');
            relatorioResumo.innerHTML = 'Carregando...';
            relatorioDetalhes.innerHTML = '';

            remediosRef.once('value', (snapshot) => {
                const remedios = snapshot.val();
                if (!remedios) {
                    relatorioResumo.textContent = 'Nenhum tratamento registrado.';
                    return;
                }

                let totalRemedios = 0;
                let totalDosesGeral = 0;
                let dosesTomadasGeral = 0;

                let detalhesHtml = '';

                for (const remedioId in remedios) {
                    totalRemedios++;
                    const remedio = remedios[remedioId];
                    detalhesHtml += `<div class="mb-4 p-3 border rounded-md bg-white shadow-sm">`;
                    detalhesHtml += `<h4 class="font-bold text-blue-700">${remedio.nome} (${remedio.dosagem || 'N/A'})</h4>`;
                    detalhesHtml += `<p>Intervalo: ${remedio.intervalo}h | InÃ­cio: ${new Date(remedio.dataInicio).toLocaleDateString('pt-BR')}</p>`;
                    
                    let remedioDosesTomadas = 0;
                    let remedioTotalDoses = 0;

                    if (remedio.doses) {
                        for (const data in remedio.doses) {
                            for (const horario in remedio.doses[data]) {
                                remedioTotalDoses++;
                                if (remedio.doses[data][horario].tomada) {
                                    remedioDosesTomadas++;
                                }
                            }
                        }
                    }
                    totalDosesGeral += remedioTotalDoses;
                    dosesTomadasGeral += remedioDosesTomadas;

                    detalhesHtml += `<p>Doses Tomadas: ${remedioDosesTomadas} / ${remedioTotalDoses}</p>`;
                    detalhesHtml += `</div>`;
                }

                relatorioResumo.textContent = `Total de ${totalRemedios} tratamentos registrados. ${dosesTomadasGeral} de ${totalDosesGeral} doses tomadas no total.`;
                relatorioDetalhes.innerHTML = detalhesHtml;
            });
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
