<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Compras Inteligentes</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        :root {
            --cor-fundo: #f8f9fa;
            --cor-container: #ffffff;
            --cor-primaria: #007bff;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-texto-principal: #333;
            --cor-texto-secundario: #6c757d;
            --cor-borda: #dee2e6;
            --sombra: 0 4px 15px rgba(0, 0, 0, 0.1);
            --raio-borda: 12px;
            --font-principal: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-principal); background-color: var(--cor-fundo); color: var(--cor-texto-principal); }
        .app-container { max-width: 1000px; margin: 0 auto; padding: 15px; visibility: hidden; }
        .app-container.loaded { visibility: visible; }

        #back-button { padding: 8px 16px; font-size: 1rem; background-color: var(--cor-container); border: 1px solid var(--cor-borda); border-radius: 8px; cursor: pointer; color: var(--cor-texto-principal); text-decoration: none; display: inline-block; margin-bottom: 20px; }

        .header-card {
            background: linear-gradient(145deg, #007bff, #0056b3);
            padding: 20px;
            border-radius: var(--raio-borda);
            box-shadow: var(--sombra);
            margin-bottom: 30px;
            color: white;
            border: 1px solid var(--cor-borda);
        }

        #form-adicionar-item { display: flex; flex-direction: column; gap: 10px; }
        #input-novo-item {
            width: 100%; padding: 15px; border-radius: 10px;
            border: 1px solid var(--cor-borda); font-size: 1.2rem;
            background-color: var(--cor-container); color: var(--cor-texto-principal);
            box-sizing: border-box;
        }
        #input-novo-item::placeholder { color: var(--cor-texto-secundario); }
        #input-novo-item:focus {
            outline: none; border-color: var(--cor-primaria);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }
        .btn {
            padding: 15px; border: none; border-radius: 10px;
            font-size: 1.2rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-adicionar { background: var(--cor-primaria); }
        .btn-finalizar { background: var(--cor-sucesso); width: 100%; margin-top: 10px; }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { transform: scale(0.98); filter: brightness(0.9); }

        .lista-titulo {
            font-size: 1.8rem; font-weight: 700; margin-top: 40px;
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--cor-borda);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .item-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px; min-height: 140px;
        }

        .item-card {
            aspect-ratio: 1 / 1; background-color: var(--cor-container);
            border-radius: var(--raio-borda); box-shadow: var(--sombra);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: center; padding: 10px; position: relative;
            border: 1px solid var(--cor-borda);
        }
        .item-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .item-card.falling { animation: fall-into-cart 0.9s cubic-bezier(0.55, 0, 1, 0.45) forwards; z-index: 1000; }
        .item-emoji { font-size: 3.5rem; line-height: 1; user-select: none; }
        .item-name { font-size: 1.1rem; font-weight: 500; margin-top: 8px; word-break: break-word; }
        
        .delete-btn {
            position: absolute; top: 5px; right: 5px; width: 28px; height: 28px;
            background-color: rgba(0,0,0,0.2); border: none; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: all 0.3s; z-index: 2;
        }
        .item-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background-color: var(--cor-perigo); }
        .delete-btn svg { width: 16px; height: 16px; stroke: var(--cor-texto-principal); }

        .carrinho-container {
            margin-top: 40px; position: relative; width: 100%;
            max-width: 650px; margin-left: auto; margin-right: auto;
        }
        .carrinho-svg { width: 100%; height: auto; filter: drop-shadow(10px 20px 25px rgba(0,0,0,0.3)); }
        #lista-comprados {
            position: absolute; top: 10%; left: 8%;
            width: 80%; height: 52%;
            display: flex; flex-wrap: wrap; gap: 12px;
            align-content: flex-start; padding: 15px;
            overflow-y: auto; box-sizing: border-box;
            transform: skewY(-4.5deg) rotate(-1.8deg);
            border-radius: 5px 5px 20px 20px;
        }
        #lista-comprados .item-card {
            width: 60px; height: 60px; border-radius: 12px;
            background-color: var(--cor-container);
            border: 1px solid var(--cor-borda);
            box-shadow: 0 3px 6px rgba(0,0,0,0.6);
            animation: land-in-cart 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        #lista-comprados .item-emoji { font-size: 2rem; }
        #lista-comprados .item-name { display: none; }
        #lista-comprados .delete-btn { display: none; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 2000;
        }
        .overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--cor-container); padding: 20px; border-radius: var(--raio-borda);
            width: 90%; max-width: 400px; border: 1px solid var(--cor-borda);
            text-align: center;
        }
        .modal-content h3 { font-size: 1.5rem; margin-top: 0; margin-bottom: 10px; }
        .modal-content p { font-size: 1.1rem; color: var(--cor-texto-secundario); margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm { background-color: var(--cor-perigo); }
        .btn-cancel { background-color: #6c757d; }

        #report-paper {
            background: #f8f9fa; color: #333; padding: 20px;
            font-family: 'Courier New', monospace; white-space: pre-wrap;
            max-height: 60vh; overflow-y: auto; border: 1px solid var(--cor-borda);
            margin-bottom: 20px; border-radius: 8px; text-align: left;
        }
        
        .spinner {
            width: 50px; height: 50px; border: 6px solid rgba(0,0,0,0.1);
            border-top-color: var(--cor-primaria); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        
        @keyframes fall-into-cart {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            30% { transform: translate(20px, -50px) scale(1.1) rotate(-5deg); opacity: 1; }
            100% { transform: translate(30px, 400px) scale(0.25) rotate(15deg); opacity: 0; }
        }

        @keyframes land-in-cart {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #install-banner {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 15px;
            background-color: #007bff; color: white; text-align: center; display: none;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        #install-banner-buttons {
            margin-top: 10px;
        }
        #install-banner-buttons button {
            background: white; color: #007bff; border: none; padding: 8px 16px;
            border-radius: 5px; margin: 0 5px; cursor: pointer;
        }
        #install-banner-buttons button:last-child {
            background: #28a745; color: white;
        }
        #install-banner-buttons button:last-child:hover {
            background: #218838;
        }
        #install-banner-buttons button:first-child:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>

    <div id="install-banner">
        <p>Leve sua lista de compras para a tela inicial!</p>
        <div id="install-banner-buttons">
            <button id="dismiss-btn">Agora n√£o</button>
            <button id="install-btn">Instalar</button>
        </div>
    </div>

    <div class="app-container">
        <a href="../../dashboard.html" id="back-button">‚ùÆ Voltar</a>
        <div class="header-card">
            <form id="form-adicionar-item">
                <input type="text" id="input-novo-item" placeholder="O que voc√™ precisa comprar?">
                <button type="submit" class="btn btn-adicionar">Adicionar √† Lista</button>
            </form>
            <button id="btn-finalizar" class="btn btn-finalizar">Finalizar Compra</button>
        </div>

        <h2 class="lista-titulo">Prateleira</h2>
        <div id="lista-a-comprar" class="item-grid"></div>

        <h2 class="lista-titulo">Seu Carrinho</h2>
        <div class="carrinho-container">
            <svg class="carrinho-svg" viewBox="0 0 650 420" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="gradMetal" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#E0E0E0"/><stop offset="50%" stop-color="#BDBDBD"/><stop offset="100%" stop-color="#E0E0E0"/></linearGradient><linearGradient id="gradHandle" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#4dabf7"/><stop offset="100%" stop-color="#1864ab"/></linearGradient></defs><g fill="none" stroke="url(#gradMetal)" stroke-width="8"><path d="M140 380 Q 130 400, 110 400 H 90" stroke-width="12"/><path d="M520 380 Q 510 400, 490 400 H 470" stroke-width="12"/><g stroke-width="6" fill="#343a40"><circle cx="140" cy="380" r="30"/><circle cx="520" cy="380" r="30"/></g><g fill="#BDBDBD"><circle cx="140" cy="380" r="12"/><circle cx="520" cy="380" r="12"/></g><path d="M170 380 H 490" stroke-width="12"/><path d="M60 60 L120 280 L530 280 L590 60 Z" stroke-linejoin="round" stroke-linecap="round" stroke-width="14"/><g stroke-width="5" stroke-linecap="round" opacity="0.8"><path d="M85 120 H 565"/><path d="M100 180 H 550"/><path d="M110 240 H 540"/></g><path d="M120 280 Q 70 310, 90 400"/><path d="M530 280 L 490 350"/><path d="M590 60 C 620 40, 640 50, 640 80 L 610 180" stroke-width="12"/><rect x="595" y="40" width="30" height="60" rx="15" fill="url(#gradHandle)" stroke="#1c2b3a" stroke-width="2" transform="rotate(25 610 70)"/><g fill="#495057" stroke="#212529" stroke-width="1"><rect x="45" y="45" width="30" height="30" rx="5"/><rect x="575" y="45" width="30" height="30" rx="5"/></g></g>
            </svg>
            <div id="lista-comprados"></div>
        </div>
    </div>

    <div id="confirmation-modal" class="overlay">
        <div class="modal-content">
            <h3 id="confirmation-title"></h3>
            <p id="confirmation-message"></p>
            <div class="modal-actions">
                <button id="btn-confirm-action" class="btn btn-confirm">Confirmar</button>
                <button id="btn-cancel-action" class="btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="overlay">
        <div class="modal-content">
            <h3 id="notification-title"></h3>
            <p id="notification-message"></p>
            <div class="modal-actions">
                <button id="btn-ok-notification" class="btn btn-adicionar">Ok</button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="overlay">
        <div class="modal-content">
            <h3>Relat√≥rio da Compra</h3>
            <div id="report-paper"></div>
            <div class="modal-actions">
                <button id="btn-zerar-lista" class="btn btn-confirm">Zerar e Nova Compra</button>
                <button id="btn-fechar-relatorio" class="btn btn-cancel">Fechar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="overlay visible">
        <div style="text-align: center; color: var(--cor-texto-principal);">
            <div class="spinner"></div>
            <p>Carregando sua lista...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DA APLICA√á√ÉO ---
            let itemsRef = null;
            let localItems = [];

            // --- MAPA DE EMOJIS ---
            const emojiMap = {
                'maca': 'üçé',
                'ma√ß√£': 'üçé',
                'maca verde': 'üçè',
                'ma√ß√£ verde': 'üçè',
                'pera': 'üçê',
                'p√™ra': 'üçê',
                'laranja': 'üçä',
                'limao': 'üçã',
                'lim√£o': 'üçã',
                'banana': 'üçå',
                'uva': 'üçá',
                'morango': 'üçì',
                'mirtilo': 'ü´ê',
                'melancia': 'üçâ',
                'cereja': 'üçí',
                'pessego': 'üçë',
                'p√™ssego': 'üçë',
                'manga': 'ü•≠',
                'abacaxi': 'üçç',
                'coco': 'ü••',
                'kiwi': 'ü•ù',
                'tomate': 'üçÖ',
                'abacate': 'ü•ë',
                'melao': 'üçà',
                'mel√£o': 'üçà',
                'cenoura': 'ü•ï',
                'berinjela': 'üçÜ',
                'batata': 'ü•î',
                'batata doce': 'üç†',
                'milho': 'üåΩ',
                'pimenta': 'üå∂Ô∏è',
                'pimentao': 'ü´ë',
                'piment√£o': 'ü´ë',
                'pepino': 'ü•í',
                'alface': 'ü•¨',
                'brocolis': 'ü•¶',
                'br√≥colis': 'ü•¶',
                'alho': 'üßÑ',
                'cebola': 'üßÖ',
                'cogumelo': 'üçÑ',
                'amendoim': 'ü•ú',
                'castanha': 'üå∞',
                'ervilha': 'ü´õ',
                'gengibre': 'ü´ö',
                'azeitona': 'ü´í',
                'salada': 'ü•ó',
                'pao': 'üçû',
                'p√£o': 'üçû',
                'baguete': 'ü•ñ',
                'croissant': 'ü•ê',
                'pretzel': 'ü•®',
                'bagel': 'ü•Ø',
                'panqueca': 'ü•û',
                'waffle': 'üßá',
                'cereal': 'ü•£',
                'arroz': 'üçö',
                'feijao': 'ü´ò',
                'feij√£o': 'ü´ò',
                'macarrao': 'üçù',
                'macarr√£o': 'üçù',
                'massa': 'üçù',
                'ramen': 'üçú',
                'carne': 'ü•©',
                'bife': 'ü•©',
                'pernil': 'üçñ',
                'presunto': 'üçñ',
                'frango': 'üçó',
                'peixe': 'üêü',
                'salsicha': 'üå≠',
                'bacon': 'ü•ì',
                'camarao': 'üç§',
                'camar√£o': 'üç§',
                'lagosta': 'ü¶û',
                'caranguejo': 'ü¶Ä',
                'lula': 'ü¶ë',
                'ostra': 'ü¶™',
                'sushi': 'üç£',
                'leite': 'ü•õ',
                'ovo': 'ü•ö',
                'queijo': 'üßÄ',
                'manteiga': 'üßà',
                'cafe': '‚òïÔ∏è',
                'caf√©': '‚òïÔ∏è',
                'cha': 'üçµ',
                'ch√°': 'üçµ',
                'suco': 'üßÉ',
                'refrigerante': 'ü•§',
                'agua': 'üíß',
                '√°gua': 'üíß',
                'agua de coco': 'ü••',
                'cerveja': 'üç∫',
                'vinho': 'üç∑',
                'espumante': 'üçæ',
                'whisky': 'ü•É',
                'drink': 'üçπ',
                'coquetel': 'üç∏',
                'chimarrao': 'üßâ',
                'chimarr√£o': 'üßâ',
                'gelo': 'üßä',
                'chocolate': 'üç´',
                'doce': 'üç¨',
                'pirulito': 'üç≠',
                'biscoito': 'üç™',
                'bolacha': 'üç™',
                'bolo': 'üç∞',
                'cupcake': 'üßÅ',
                'torta': 'ü•ß',
                'sorvete': 'üç¶',
                'raspadinha': 'üçß',
                'sorvete de taca': 'üç®',
                'sorvete de ta√ßa': 'üç®',
                'donut': 'üç©',
                'pudim': 'üçÆ',
                'mel': 'üçØ',
                'pipoca': 'üçø',
                'pizza': 'üçï',
                'hamburguer': 'üçî',
                'hamb√∫rguer': 'üçî',
                'sanduiche': 'ü•™',
                'sandu√≠che': 'ü•™',
                'batata frita': 'üçü',
                'taco': 'üåÆ',
                'burrito': 'üåØ',
                'kebab': 'ü•ô',
                'falafel': 'üßÜ',
                'onigiri': 'üçô',
                'comida chinesa': 'ü•°',
                'fondue': 'ü´ï',
                'enlatado': 'ü•´',
                'conserva': 'ü´ô',
                'sabao': 'üßº',
                'sab√£o': 'üßº',
                'detergente': 'üßΩ',
                'esponja': 'üßΩ',
                'limpeza': 'üßπ',
                'vassoura': 'üßπ',
                'balde': 'ü™£',
                'cesto': 'üß∫',
                'saco de lixo': 'üóëÔ∏è',
                'shampoo': 'üß¥',
                'condicionador': 'üß¥',
                'papel': 'üßª',
                'papel higienico': 'üßª',
                'papel higi√™nico': 'üßª',
                'escova de dentes': 'ü™•',
                'lamina de barbear': 'ü™í',
                'l√¢mina de barbear': 'ü™í',
                'curativo': 'ü©π',
                'remedio': 'üíä',
                'rem√©dio': 'üíä',
                'racao': 'ü¶¥',
                'ra√ß√£o': 'ü¶¥',
                'vela': 'üïØÔ∏è',
                'lampada': 'üí°',
                'l√¢mpada': 'üí°',
                'pilha': 'üîã',
                'planta': 'ü™¥',
                'flor': 'üíê',
                'default': 'üõí'
            };

            const getEmojiForItem = (nome) => {
                const nomeLower = nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                for (const key in emojiMap) { if (nomeLower.includes(key)) return emojiMap[key]; }
                return emojiMap.default;
            };

            // --- ELEMENTOS DA UI ---
            const ui = {
                appContainer: document.querySelector('.app-container'),
                form: document.getElementById('form-adicionar-item'),
                input: document.getElementById('input-novo-item'),
                listaAComprar: document.getElementById('lista-a-comprar'),
                listaComprados: document.getElementById('lista-comprados'),
                btnFinalizar: document.getElementById('btn-finalizar'),
                loadingOverlay: document.getElementById('loading-overlay'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmationTitle: document.getElementById('confirmation-title'),
                confirmationMessage: document.getElementById('confirmation-message'),
                btnConfirm: document.getElementById('btn-confirm-action'),
                btnCancel: document.getElementById('btn-cancel-action'),
                notificationModal: document.getElementById('notification-modal'),
                notificationTitle: document.getElementById('notification-title'),
                notificationMessage: document.getElementById('notification-message'),
                btnOk: document.getElementById('btn-ok-notification'),
                reportModal: document.getElementById('report-modal'),
                reportPaper: document.getElementById('report-paper'),
                btnZerarLista: document.getElementById('btn-zerar-lista'),
                btnFecharRelatorio: document.getElementById('btn-fechar-relatorio'),
            };
            
            // --- L√ìGICA DE MODAIS ---
            const modals = {
                showNotification: (title, message) => {
                    ui.notificationTitle.textContent = title;
                    ui.notificationMessage.textContent = message;
                    ui.notificationModal.classList.add('visible');
                },
                showConfirmation: (title, message) => {
                    ui.confirmationTitle.textContent = title;
                    ui.confirmationMessage.textContent = message;
                    ui.confirmationModal.classList.add('visible');
                    
                    return new Promise((resolve) => {
                        ui.btnConfirm.onclick = () => { ui.confirmationModal.classList.remove('visible'); resolve(true); };
                        ui.btnCancel.onclick = () => { ui.confirmationModal.classList.remove('visible'); resolve(false); };
                    });
                }
            };

            // --- RENDERIZA√á√ÉO ---
            const render = {
                createItemElement: (item, isBasket = false) => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.dataset.id = item.id;
                    
                    let content = `<div class="item-emoji">${item.emoji}</div>`;
                    if (!isBasket) {
                        content += `<div class="item-name">${item.nome}</div>`;
                    }

                    card.innerHTML = `
                        <button class="delete-btn" title="Remover item">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        ${content}
                    `;
                    return card;
                },
                updateLists: (items) => {
                    localItems = items; // Atualiza a lista local
                    ui.listaAComprar.innerHTML = '';
                    ui.listaComprados.innerHTML = '';
                    
                    const itensFaltando = items.filter(i => !i.comprado);
                    const itensComprados = items.filter(i => i.comprado);

                    if (items.length === 0) {
                         ui.listaAComprar.innerHTML = `<p style="color: var(--cor-texto-secundario); grid-column: 1 / -1; text-align: center;">Sua lista est√° vazia. Adicione um item acima.</p>`;
                    } else {
                        itensFaltando.sort((a, b) => a.createdAt - b.createdAt).forEach(item => ui.listaAComprar.appendChild(render.createItemElement(item)));
                        itensComprados.sort((a, b) => a.createdAt - b.createdAt).forEach(item => {
                            const card = render.createItemElement(item, true);
                            card.style.animation = 'none';
                            ui.listaComprados.appendChild(card);
                        });
                    }
                }
            };

            // --- L√ìGICA DO FIREBASE ---
            const interactions = {
                addItem: async (e) => {
                    e.preventDefault();
                    const nome = ui.input.value.trim();
                    if (nome && itemsRef) {
                        const newItemRef = itemsRef.push(); // Gera um ID √∫nico
                        await newItemRef.set({
                            id: newItemRef.key, // Salva o ID junto com os dados
                            nome: nome,
                            emoji: getEmojiForItem(nome),
                            comprado: false,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        ui.input.value = '';
                        ui.input.focus();
                    }
                },
                deleteItem: async (id) => {
                    const confirmed = await modals.showConfirmation('Remover Item', 'Deseja realmente remover este item?');
                    if (confirmed) await itemsRef.child(id).remove();
                },
                toggleItemStatus: async (id, element) => {
                    const item = localItems.find(i => i.id === id);
                    if (!item) return;

                    const isComprado = item.comprado;
                    if (!isComprado) {
                        element.classList.add('falling');
                        setTimeout(() => itemsRef.child(id).update({ comprado: true }), 850);
                    } else {
                        itemsRef.child(id).update({ comprado: false });
                    }
                },
                showReport: () => {
                    const itensComprados = localItems.filter(i => i.comprado);
                    if (itensComprados.length === 0) {
                        modals.showNotification('Carrinho Vazio', 'Voc√™ ainda n√£o adicionou nenhum item ao seu carrinho.');
                        return;
                    }
                    const itensFaltando = localItems.filter(i => !i.comprado);
                    let reportText = `Relat√≥rio de Compras - ${new Date().toLocaleString('pt-BR')}\n\n--- ITENS NO CARRINHO (${itensComprados.length}) ---\n`;
                    itensComprados.forEach(i => reportText += `- ${i.nome}\n`);
                    if (itensFaltando.length > 0) {
                        reportText += `\n--- ITENS PENDENTES (${itensFaltando.length}) ---\n`;
                        itensFaltando.forEach(i => reportText += `- ${i.nome}\n`);
                    }
                    ui.reportPaper.textContent = reportText;
                    ui.reportModal.classList.add('visible');
                },
                resetList: async () => {
                    const confirmed = await modals.showConfirmation('Zerar Lista', 'Tem certeza que deseja apagar TUDO e come√ßar uma nova compra?');
                    if (confirmed) {
                        ui.reportModal.classList.remove('visible');
                        await itemsRef.remove();
                    }
                }
            };

            // --- INICIALIZA√á√ÉO ---
            function init() {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        // **MODIFICADO** A refer√™ncia agora √© para o Realtime Database
                        itemsRef = database.ref(`easy_lists/${user.uid}/items`);
                        
                        ui.appContainer.classList.add('loaded');
                        ui.loadingOverlay.classList.remove('visible');

                        itemsRef.on('value', snapshot => {
                            const data = snapshot.val();
                            const itemsArray = data ? Object.values(data) : [];
                            render.updateLists(itemsArray);
                        }, error => {
                            console.error("Erro no Realtime Database: ", error);
                            modals.showNotification('Erro de Conex√£o', 'N√£o foi poss√≠vel carregar sua lista. Verifique sua internet.');
                        });
                    } else {
                        window.location.replace('../index.html');
                    }
                });
            }
            
            ui.form.addEventListener('submit', interactions.addItem);
            ui.btnFinalizar.addEventListener('click', interactions.showReport);
            ui.btnZerarLista.addEventListener('click', interactions.resetList);
            ui.btnFecharRelatorio.addEventListener('click', () => ui.reportModal.classList.remove('visible'));
            ui.btnOk.addEventListener('click', () => ui.notificationModal.classList.remove('visible'));

            document.querySelector('.app-container').addEventListener('click', (e) => {
                const card = e.target.closest('.item-card');
                if (!card) return;
                const id = card.dataset.id;
                if (e.target.closest('.delete-btn')) interactions.deleteItem(id);
                else interactions.toggleItemStatus(id, card);
            });

            init();
            
            // --- REGISTRO DO SERVICE WORKER (PWA) ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(reg => console.log('Service worker registrado.'))
                        .catch(err => console.log('Erro no registro do Service worker: ', err));
                });
            }

            // --- Instala√ß√£o PWA ---
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBanner = document.getElementById('install-banner');
                installBanner.style.display = 'block';
            });

            document.getElementById('install-btn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usu√°rio aceitou o prompt de instala√ß√£o');
                        } else {
                            console.log('Usu√°rio recusou o prompt de instala√ß√£o');
                        }
                        deferredPrompt = null;
                    });
                }
            });

            document.getElementById('dismiss-btn').addEventListener('click', () => {
                document.getElementById('install-banner').style.display = 'none';
            });
        });
    </script>
</body>
</html>
