<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lista de Compras Inteligente</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="theme-color" content="#007bff"/>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f8f9fa; display: flex; flex-direction: column; height: 100vh; }
        .header { background-color: #007bff; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 1.25rem; margin: 0; }
        .header a, .header button { color: white; background-color: rgba(255,255,255,0.2); text-decoration: none; padding: 6px 12px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; border: none; cursor: pointer; }
        .main-container { flex-grow: 1; padding: 15px; overflow-y: auto; }
        #form-item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin-bottom: 20px; }
        #form-item input { padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
        #form-item button { padding: 12px 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        #btn-adicionar { background-color: #007bff; }
        #lista-compras { list-style: none; padding: 0; }
        .item-compra { background-color: white; padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; }
        .item-info { display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center; flex-grow: 1; }
        .item-info input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .item-details { display: flex; flex-direction: column; }
        .item-details span { font-size: 1.1rem; }
        .item-details small { color: #6c757d; }
        .item-compra.checked .item-details { text-decoration: line-through; opacity: 0.6; }
        .item-actions button { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #dc3545; }
        .footer-bar { background-color: #ffffff; padding: 15px; border-top: 1px solid #e9ecef; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); text-align: center; }
        #total-gastos { font-size: 1.2rem; font-weight: bold; }
        #btn-finalizar { background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; width: 100%; }
        #auth-container { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .auth-box { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 90%; }
    </style>
</head>
<body>
    <div id="auth-container" style="display: none;">
        <div class="auth-box">
            <h2 id="auth-title">Acesso Negado</h2>
            <p id="auth-message">Sua sessão é inválida. Por favor, retorne e faça login.</p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="header">
            <a href="../../dashboard.html">❮ Voltar</a>
            <h1>Lista Inteligente</h1>
            <button id="logout-btn">Sair</button>
        </header>

        <main class="main-container">
            <form id="form-item">
                <input type="text" id="nome-item" placeholder="Nome do item" required>
                <input type="number" id="preco-item" placeholder="Preço" step="0.01" min="0">
                <button type="submit" id="btn-adicionar">Add</button>
            </form>
            <ul id="lista-compras"></ul>
        </main>

        <footer class="footer-bar">
            <div id="total-gastos">Total: R$ 0.00</div>
            <button id="btn-finalizar">Finalizar Compra</button>
        </footer>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script src="../../firebase-config.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const App = {
            currentUser: null,
            itemsRef: null,
            authTimeout: null,

            init() {
                this.addAuthListener();
                this.addEventListeners();
            },

            showView(view) {
                clearTimeout(this.authTimeout);
                document.getElementById('app-container').style.display = (view === 'app') ? 'flex' : 'none';
                document.getElementById('auth-container').style.display = (view === 'auth') ? 'flex' : 'none';
            },

            showAuthMessage(title, message) {
                document.getElementById('auth-title').textContent = title;
                document.getElementById('auth-message').textContent = message;
                this.showView('auth');
            },

            addAuthListener() {
                // LÓGICA APERFEIÇOADA PARA MODO ANÔNIMO
                this.authTimeout = setTimeout(() => {
                    this.showAuthMessage(
                        'Modo Anônimo Detectado', 
                        'A autenticação pode não funcionar em abas privadas ou anônimas. Por favor, use uma janela normal do navegador.'
                    );
                }, 3000);

                auth.onAuthStateChanged(async user => {
                    clearTimeout(this.authTimeout);

                    if (user) {
                        const userRef = database.ref(`users_public_list/${user.uid}`);
                        const snapshot = await userRef.once('value');
                        const userData = snapshot.val();

                        if (userData && userData.isBlocked) {
                            this.showAuthMessage('Conta Bloqueada', 'Sua conta foi bloqueada. Contate o administrador.');
                            return;
                        }
                        
                        this.currentUser = user;
                        this.itemsRef = database.ref(`shopping_lists/${user.uid}`);
                        this.loadItems();
                        this.showView('app');
                    } else {
                        this.currentUser = null;
                        if (this.itemsRef) this.itemsRef.off();
                        this.showAuthMessage('Acesso Negado', 'Sua sessão é inválida ou expirou. Por favor, retorne e faça login.');
                    }
                });
            },

            loadItems() {
                this.itemsRef.on('value', snapshot => {
                    const items = snapshot.val();
                    UI.renderItems(items);
                });
            },

            addEventListeners() {
                document.getElementById('form-item').addEventListener('submit', ItemManager.addItem);
                document.getElementById('btn-finalizar').addEventListener('click', ItemManager.finalizePurchase);
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            }
        };

        const ItemManager = {
            addItem(e) { e.preventDefault(); if (!App.currentUser) return; const nomeInput = document.getElementById('nome-item'); const precoInput = document.getElementById('preco-item'); const nome = nomeInput.value.trim(); const preco = parseFloat(precoInput.value) || 0; if (nome) { App.itemsRef.push({ name: nome, price: preco, checked: false }); nomeInput.value = ''; precoInput.value = ''; nomeInput.focus(); } },
            toggleItem(itemId) { if (!App.currentUser) return; const itemRef = App.itemsRef.child(itemId); itemRef.once('value', snapshot => { const currentStatus = snapshot.val().checked; itemRef.update({ checked: !currentStatus }); }); },
            deleteItem(itemId) { if (!App.currentUser) return; App.itemsRef.child(itemId).remove(); },
            finalizePurchase() {
                if (!App.currentUser) return;
                App.itemsRef.once('value', snapshot => {
                    const items = snapshot.val();
                    if (!items) { alert("Sua lista está vazia!"); return; }
                    const location = prompt("Onde a compra foi realizada? (Deixe em branco se não aplicável)", "Não informado");
                    const total = Object.values(items).reduce((sum, item) => sum + (item.checked ? item.price : 0), 0);
                    let reportContent = `*** CUPOM FISCAL ***\n\nLOCAL: ${location || 'Não informado'}\nDATA: ${new Date().toLocaleString('pt-BR')}\n--------------------------------\nITEM      QTD    PREÇO    TOTAL\n--------------------------------\n`;
                    Object.values(items).forEach(item => { if (item.checked) { const name = item.name.padEnd(10); const price = item.price.toFixed(2).padStart(7); const totalItem = (item.price).toFixed(2).padStart(7); reportContent += `${name}  1 x ${price} = ${totalItem}\n`; } });
                    reportContent += `--------------------------------\nTOTAL A PAGAR: R$ ${total.toFixed(2)}\n\n***** thIAguinho Soluções *****`;
                    const reportsRef = database.ref(`purchase_reports/${App.currentUser.uid}`);
                    reportsRef.push({ createdAt: new Date().toISOString(), total: total, location: location, content: reportContent })
                        .then(() => {
                            alert(`Relatório salvo!\n\n${reportContent}`);
                            Object.keys(items).forEach(key => { if (items[key].checked) { App.itemsRef.child(key).remove(); } });
                        }).catch(error => console.error("Erro ao salvar relatório:", error));
                });
            }
        };

        const UI = {
            renderItems(items) {
                const lista = document.getElementById('lista-compras');
                lista.innerHTML = '';
                let total = 0;
                if (items) {
                    Object.keys(items).forEach(key => {
                        const item = items[key];
                        const li = document.createElement('li');
                        li.className = `item-compra ${item.checked ? 'checked' : ''}`;
                        li.dataset.id = key;
                        li.innerHTML = `<div class="item-info"><input type="checkbox" ${item.checked ? 'checked' : ''}><div class="item-details"><span>${item.name}</span><small>R$ ${item.price.toFixed(2)}</small></div></div><div class="item-actions"><button class="btn-excluir">&times;</button></div>`;
                        li.querySelector('input[type="checkbox"]').addEventListener('click', () => ItemManager.toggleItem(key));
                        li.querySelector('.btn-excluir').addEventListener('click', () => ItemManager.deleteItem(key));
                        lista.appendChild(li);
                        if (item.checked) { total += item.price; }
                    });
                }
                document.getElementById('total-gastos').textContent = `Total: R$ ${total.toFixed(2)}`;
            }
        };

        App.init();
    });
    </script>
</body>
</html>